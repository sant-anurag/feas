{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard — Forvia PRISM{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-grid">

  {# ---------------- PDL SECTION (render only if context.pdl_view True) ---------------- #}
  {% if pdl_view %}
  <section class="dashboard-card pdl-card">
    <div class="card-header">
      <h3>Yearly Summary — {{ year }}</h3>
      <div class="card-actions">
        <select id="yearSelect">
          {% for y in available_years %}
              <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    {# ---------------- KPI cards: HOURS ONLY (no cost) ---------------- #}
    <div class="kpis">
      <div class="kpi">
        <div class="kpi-value" id="pdl_punching">{{ pdl_totals.ytd_hours|default:"0" }}</div>
        <div class="kpi-label">Punching YTD (hours)</div>
      </div>

      <div class="kpi">
        <div class="kpi-value" id="pdl_allotted">--</div>
        <div class="kpi-label">Hours Allotted YTD</div>
      </div>

      <div class="kpi">
        <div class="kpi-value" id="pdl_remaining">--</div>
        <div class="kpi-label">Remaining Hours YTD</div>
      </div>
    </div>

    {# ---------------- Controls: Dept + Month selectors ---------------- #}
    <div class="controls my-3 flex items-center gap-3">
      <label class="text-sm">Department</label>
      <select id="pdlDeptSelect" class="form-input">
        <option value="">All departments</option>
        {# Build department list via AJAX (or you can prepopulate if you have that context) #}
      </select>

      <label class="text-sm">Month</label>
      <select id="pdlMonthSelect" class="form-input">
        <option value="">YTD (all)</option>
        <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
        <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
        <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
        <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
      </select>

      <button id="pdlRefresh" class="btn border px-3 py-1 rounded">Refresh</button>
    </div>

    {# ---------------- Charts: Hours trend + Program breakdown (progress tiles) ---------------- #}
    <div class="charts">
      <div class="chart-card">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold">Hours trend — Allotted vs Consumed</h4>
          <div id="trendSubtitle" class="text-sm text-muted">YTD</div>
        </div>
        <canvas id="pdlHoursChart" height="220"></canvas>
      </div>

      <div class="chart-card small mt-4">
        <h4 class="font-semibold">Program / Department Progress</h4>
        <div id="pdlProgressList" class="space-y-3 mt-3">
          <!-- progress items will be injected here -->
        </div>
      </div>
    </div>

    {# Removed: IOMs with variance table (was in earlier template). We intentionally hide that here. #}

  </section>
  {% endif %}


  {# ---------------- MANAGER SECTION (unchanged) ---------------- #}
  {% if manager_view %}
  <section class="dashboard-card manager-card">
    <div class="card-header">
      <h3>Team Performance — {{ manager_team.name|default:"My Team" }}</h3>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="kpi-value">{{ manager_totals.team_alloc|default:0 }}</div><div class="kpi-label">Total Alloc (hrs)</div></div>
      <div class="kpi"><div class="kpi-value">{{ manager_totals.billing_ratio|default:"0%" }}</div><div class="kpi-label">Billing Ratio</div></div>
      <div class="kpi"><div class="kpi-value">{{ manager_totals.open_allocations|default:0 }}</div><div class="kpi-label">Open Allocations</div></div>
    </div>

    <div class="team-chart">
      <canvas id="managerBillingChart" height="160"></canvas>
    </div>

    <div class="team-table">
      <table class="table">
        <thead><tr><th>Member</th><th>Allocated</th><th>Billed</th><th>Ratio</th><th>Actions</th></tr></thead>
        <tbody>
          {% for r in reportees %}
            <tr>
              <td>{{ r.name }}</td>
              <td>{{ r.allocated_hours }}</td>
              <td>{{ r.billed_hours }}</td>
              <td>{{ r.billing_ratio }}%</td>
              <td><a href="{% url 'profiles:view' r.user_id %}">View</a></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </section>
  {% endif %}


  {# ---------------- INDIVIDUAL SECTION (unchanged) ---------------- #}
  <section class="dashboard-card user-card">
    <div class="card-header">
      <h3>Personal Utilization</h3>
      <div class="card-actions">
        <select id="userMonthSelector" name="month">
          {% for m in last_12_months %}
            <option value="{{ m.iso }}" {% if m.iso == selected_month %}selected{% endif %}>{{ m.label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="kpi-value">{{ user_stats.this_month_hours }}</div>
        <div class="kpi-label">This month hours</div>
      </div>
      <div class="kpi">
        <div class="kpi-value">{{ user_stats.utilization_percent }}%</div>
        <div class="kpi-label">Utilization</div>
      </div>
      <div class="kpi">
        <div class="kpi-value">{{ user_stats.remaining_hours }}</div>
        <div class="kpi-label">Remaining hours</div>
      </div>
    </div>

    <div class="user-chart">
      <canvas id="userUtilChart" height="140"></canvas>
    </div>

    <div class="alloc-list">
      <h4>Current Allocations</h4>
      <ul class="allocs">
        {% for a in user_allocations %}
          <li>
            <strong>{{ a.project_name }}</strong><span class="muted"> — {{ a.total_hours }} hrs</span>
          </li>
        {% empty %}
          <li>No allocations assigned.</li>
        {% endfor %}
      </ul>
    </div>
  </section>
</div>

{% endblock %}

{# ---------------- Inline scripts: Chart building + fetchers ---------------- #}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  // element refs
  const year = '{{ year }}';
  const chartCtx = document.getElementById('pdlHoursChart')?.getContext('2d');
  let pdlChart = null;

  function buildLineChart(labels, allotted, consumed) {
    if (!chartCtx) return;
    if (pdlChart) pdlChart.destroy();
    pdlChart = new Chart(chartCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Allotted', data: allotted, borderWidth: 2, tension: 0.3, fill: false },
          { label: 'Consumed', data: consumed, borderWidth: 2, tension: 0.3, fill: false }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  function renderProgressList(items) {
    const container = document.getElementById('pdlProgressList');
    container.innerHTML = '';
    items.forEach(it => {
      const pct = it.allotted ? Math.round((it.consumed / it.allotted) * 100) : (it.consumed ? 100 : 0);
      const color = pct > 100 ? '#ef4444' : '#0ea5a4';
      const div = document.createElement('div');
      div.className = 'p-2 border rounded';
      div.innerHTML = `
        <div class="flex justify-between items-baseline">
          <div class="text-sm font-medium">${it.program || it.department || 'Unknown'}</div>
          <div class="text-xs text-muted">${Math.round(it.consumed)}/${Math.round(it.allotted)}</div>
        </div>
        <div class="w-full bg-gray-100 rounded-full mt-2 h-2 overflow-hidden">
          <div style="width:${Math.min(pct,200)}%; height:100%; background:${color};"></div>
        </div>
        <div class="text-xs mt-1 text-muted">${pct}% of allotted</div>
      `;
      container.appendChild(div);
    });
  }

  async function loadPdlDeptList() {
    // Try to populate department select via existing pdl_dept_summary endpoint (compatible)
    try {
      const res = await fetch(`/dashboard/pdl_dept_summary/?year=${year}`);
      if (res.ok) {
        const json = await res.json();
        const select = document.getElementById('pdlDeptSelect');
        if (select) {
          select.innerHTML = '<option value="">All departments</option>';
          (json.labels || []).forEach(lbl => {
            const opt = document.createElement('option');
            opt.value = lbl;
            opt.text = lbl;
            select.appendChild(opt);
          });
        }
      }
    } catch (e){
      // silent
    }
  }

  async function loadPdlData() {
    const dept = document.getElementById('pdlDeptSelect')?.value || '';
    const month = document.getElementById('pdlMonthSelect')?.value || '';

    // 1) hours series
    const seriesRes = await fetch(`/dashboard/pdl_hours_series/?year=${year}`);
    let labels = [], allotted = [], consumed = [];
    if (seriesRes.ok) {
      const s = await seriesRes.json();
      labels = s.labels || [];
      consumed = s.consumed || [];
      allotted = s.estimated || [];
    }

    // if dept filter present we could call a dept-filtered endpoint (not implemented here)
    buildLineChart(labels, allotted, consumed);

    // 2) breakdown (month or YTD)
    const query = new URLSearchParams({ year: year });
    if (month) query.set('month', month);
    if (dept) query.set('dept', dept);
    const brkRes = await fetch(`/dashboard/pdl_program_breakdown/?${query.toString()}`);
    if (brkRes.ok) {
      const br = await brkRes.json();
      const items = br.items || [];
      renderProgressList(items);
      // update KPI cards (YTD totals)
      if (!month) {
        // compute sums for YTD
        const totalAllotted = items.reduce((s,i)=>s+(i.allotted||0),0);
        const totalConsumed = items.reduce((s,i)=>s+(i.consumed||0),0);
        document.getElementById('pdl_allotted').textContent = Math.round(totalAllotted);
        document.getElementById('pdl_punching').textContent = Math.round(totalConsumed);
        document.getElementById('pdl_remaining').textContent = Math.round(totalAllotted - totalConsumed);
      } else {
        // month selected -> compute month totals
        const totalAllotted = items.reduce((s,i)=>s+(i.allotted||0),0);
        const totalConsumed = items.reduce((s,i)=>s+(i.consumed||0),0);
        document.getElementById('pdl_allotted').textContent = Math.round(totalAllotted);
        document.getElementById('pdl_punching').textContent = Math.round(totalConsumed);
        document.getElementById('pdl_remaining').textContent = Math.round(totalAllotted - totalConsumed);
        const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        document.getElementById('trendSubtitle').textContent = 'Month: ' + (monthNames[Number(month)-1] || month);
      }
    }
  }

  // wire controls
  document.getElementById('pdlRefresh')?.addEventListener('click', loadPdlData);
  document.getElementById('pdlDeptSelect')?.addEventListener('change', loadPdlData);
  document.getElementById('pdlMonthSelect')?.addEventListener('change', loadPdlData);
  document.getElementById('yearSelect')?.addEventListener('change', function(){
    // simple behavior: reload page with new year
    const y = this.value;
    window.location.search = `?year=${y}`;
  });

  // init
  loadPdlDeptList().then(loadPdlData);

})();
</script>
{% endblock %}
