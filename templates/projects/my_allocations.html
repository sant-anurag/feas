{% extends "base.html" %}
{% load static %}
{% load dict_get %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<link rel="stylesheet" href="{% static 'css/team_allocations.css' %}">
<style>
.container { max-width:1200px; margin:18px auto; }
.panel { background:#fff; border-radius:10px; padding:18px; box-shadow:0 8px 20px rgba(2,6,23,0.04); }

.controls-row { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }

/* reuse the page-controls/control-card classes from team_allocations.css */
.page-controls { display:flex; gap:12px; align-items:center; justify-content:flex-end; margin-bottom:8px; }
.control-card { display:inline-flex; gap:10px; align-items:center; padding:8px 12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,255,0.85)); border:1px solid rgba(15,23,42,0.04); box-shadow:0 6px 18px rgba(12,36,75,0.06); }
.ctrl-label { color:#374151; font-size:13px; margin-right:6px; white-space:nowrap; }
.input-month { min-width:150px; padding:8px 10px; border-radius:10px; border:1px solid rgba(203,213,225,0.8); background:linear-gradient(180deg,#ffffff,#fbfdff); font-size:14px; }
.btn-load { background: linear-gradient(90deg, #1e3a8a 0%, #2563eb 60%); color: #fff; padding: 9px 16px; border-radius: 10px; font-weight:700; border:none; cursor:pointer; box-shadow:0 8px 20px rgba(37,99,235,0.18); }

/* toggles */
.toggle-controls { display:flex; gap:8px; margin-bottom:12px; }
.btn-toggle { padding:8px 12px; border-radius:8px; border:1px solid #e6eaf0; background:#fff; cursor:pointer; font-weight:700; }
.btn-toggle.active { background:linear-gradient(90deg,#2563eb,#1e40af); color:#fff; border:none; box-shadow:0 8px 20px rgba(37,99,235,0.12); }

/* allocations table */
.alloc-table { width:100%; border-collapse:collapse; margin-top:10px; }
.alloc-table th, .alloc-table td { padding:10px 12px; border-bottom:1px solid #eef2f7; vertical-align:middle; text-align:left; }
.alloc-table thead th { background:#f8fafc; font-weight:700; color:#374151; }

.week-punch { width:88px; padding:6px; border-radius:6px; border:1px solid #d1d5db; }

.daily-grid { width:100%; border-collapse:collapse; margin-top:12px; }
.daily-grid th, .daily-grid td { padding:8px; border-bottom:1px solid #f3f4f6; }

.remaining {
  font-size:12px; font-weight:700; padding:3px 6px; border-radius:6px;
  display:inline-block; margin-left:8px;
}
.remaining.safe { background: rgba(16,185,129,0.12); color: #065f46; }
.remaining.warn { background: rgba(245,158,11,0.12); color:#92400e; }
.remaining.over { background: rgba(239,68,68,0.12); color:#991b1b; }

.small-muted { color:#6b7280; font-size:13px; }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="panel" role="main" aria-labelledby="myAllocTitle">
    <div class="controls-row">
      <div>
        <h2 id="myAllocTitle">My Allocations — {{ month_start|date:"F Y" }}</h2>
        <p class="small-muted">Toggle between Weekly and Daily punching views. You cannot punch more than the allocated hours for the week.</p>
      </div>

      <!-- top-right month controls: submits ?month=YYYY-MM -->
      <div class="page-controls" aria-label="Month controls">
        <form method="get" class="control-card" style="align-items:center;">
          <label class="ctrl-label">Select month</label>
          <input class="input-month" type="month" name="month" value="{{ month_start|date:'Y-m' }}">
          <button class="btn-load" type="submit">Load</button>
        </form>
      </div>
    </div>

    <div class="toggle-controls" role="tablist" aria-label="View toggle">
      <button id="btn-weekly" class="btn-toggle active" role="tab" aria-selected="true">Weekly View</button>
      <button id="btn-daily" class="btn-toggle" role="tab" aria-selected="false">Daily View</button>
    </div>

    <!-- WEEKLY VIEW -->
    <div id="weekly-view" role="tabpanel" aria-labelledby="btn-weekly">
      {% if not rows %}
        <div style="padding:18px;border-radius:8px;background:#fff;">No allocations found for you this month.</div>
      {% else %}
        <table class="alloc-table" aria-describedby="WeeklyAllocTable">
          <thead>
            <tr>
              <th>Project</th>
              <th>Domain</th>
              <th>Allocated (Total)</th>
              <th>W1 Alloc</th><th>W1 Punched</th><th>W1 Punch</th>
              <th>W2 Alloc</th><th>W2 Punched</th><th>W2 Punch</th>
              <th>W3 Alloc</th><th>W3 Punched</th><th>W3 Punch</th>
              <th>W4 Alloc</th><th>W4 Punched</th><th>W4 Punch</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr data-allocation="{{ r.allocation_id }}">
                <td style="min-width:180px;">{{ r.project_name }}</td>
                <td>{{ r.domain_name }}</td>
                <td>{{ r.total_hours }}</td>

                <!-- Week 1 -->
                <td>{{ r.w1_alloc_hours }}</td>
                <td>{{ r.w1_punched_hours }}</td>
                <td>
                  <div style="display:flex;align-items:center;gap:6px;">
                    <input class="week-punch" type="number" min="0" step="0.25"
                           data-week="1" value="{{ r.w1_punched_hours }}"
                           data-alloc="{{ r.w1_alloc_hours }}" data-punched="{{ r.w1_punched_hours }}">
                    <span class="remaining" data-remaining></span>
                  </div>
                </td>

                <!-- Week 2 -->
                <td>{{ r.w2_alloc_hours }}</td>
                <td>{{ r.w2_punched_hours }}</td>
                <td>
                  <div style="display:flex;align-items:center;gap:6px;">
                    <input class="week-punch" type="number" min="0" step="0.25"
                           data-week="2" value="{{ r.w2_punched_hours }}"
                           data-alloc="{{ r.w2_alloc_hours }}" data-punched="{{ r.w2_punched_hours }}">
                    <span class="remaining" data-remaining></span>
                  </div>
                </td>

                <!-- Week 3 -->
                <td>{{ r.w3_alloc_hours }}</td>
                <td>{{ r.w3_punched_hours }}</td>
                <td>
                  <div style="display:flex;align-items:center;gap:6px;">
                    <input class="week-punch" type="number" min="0" step="0.25"
                           data-week="3" value="{{ r.w3_punched_hours }}"
                           data-alloc="{{ r.w3_alloc_hours }}" data-punched="{{ r.w3_punched_hours }}">
                    <span class="remaining" data-remaining></span>
                  </div>
                </td>

                <!-- Week 4 -->
                <td>{{ r.w4_alloc_hours }}</td>
                <td>{{ r.w4_punched_hours }}</td>
                <td>
                  <div style="display:flex;align-items:center;gap:6px;">
                    <input class="week-punch" type="number" min="0" step="0.25"
                           data-week="4" value="{{ r.w4_punched_hours }}"
                           data-alloc="{{ r.w4_alloc_hours }}" data-punched="{{ r.w4_punched_hours }}">
                    <span class="remaining" data-remaining></span>
                  </div>
                </td>

                <td style="white-space:nowrap;">
                  <button class="btn btn-save-week">Save Week</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div>

    <!-- DAILY VIEW -->
    <div id="daily-view" role="tabpanel" aria-labelledby="btn-daily" style="display:none; margin-top:12px;">
      {% if not rows %}
        <div style="padding:18px;border-radius:8px;background:#fff;">No allocations found for you this month.</div>
      {% else %}
        <p class="small-muted">Daily punching: edit hours for each date. Weekly totals are validated on save.</p>

        {% for r in rows %}
          <div style="margin-top:18px;padding:12px;border-radius:10px;background:#fbfdff;border:1px solid #eef2f7;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong>{{ r.project_name }}</strong> — <span class="small-muted">{{ r.domain_name }}</span></div>
              <div class="small-muted">Total Alloc: {{ r.total_hours }}</div>
            </div>

            <table class="daily-grid" style="margin-top:8px;">
              <thead>
                <tr>
                  <th style="width:130px">Date</th>
                  <th>Week Alloc</th>
                  <th>Punched</th>
                  <th>Enter Punch</th>
                </tr>
              </thead>
              <tbody>
                {% for d in daily_dates %}
                  {% with ds=d.date|date:"Y-m-d" %}
                  <tr data-allocation="{{ r.allocation_id }}" data-date="{{ ds }}" data-weeknum="{{ d.week_number }}">
                    <td>{{ d.date|date:"D, d M" }}</td>

                    <td>
                      {% if d.week_number == 1 %}{{ r.w1_alloc_hours }}
                      {% elif d.week_number == 2 %}{{ r.w2_alloc_hours }}
                      {% elif d.week_number == 3 %}{{ r.w3_alloc_hours }}
                      {% else %}{{ r.w4_alloc_hours }}
                      {% endif %}
                    </td>

                    <td class="existing-punch">{{ daily_map|dict_get:r.allocation_id|dict_get:ds }}</td>

                    <td>
                      <div style="display:flex;align-items:center;gap:6px;">
                        <input class="week-punch daily-input" type="number" min="0" step="0.25"
                               value="{{ daily_map|dict_get:r.allocation_id|dict_get:ds }}"
                               data-date="{{ ds }}" data-weeknum="{{ d.week_number }}">
                        <span class="remaining" data-remaining></span>
                      </div>
                    </td>
                  </tr>
                  {% endwith %}
                {% endfor %}
              </tbody>
            </table>

            <div style="margin-top:8px;text-align:right;">
              <button class="btn btn-save-daily">Save Daily Punches</button>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name){ const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v?v.pop():''; }
const CSRFTOKEN = getCookie('csrftoken');

function setRemainingSpan(span, rem, alloc){
  span.textContent = 'Rem: ' + rem.toFixed(2);
  span.classList.remove('safe','warn','over');
  if (rem < 0) span.classList.add('over');
  else if (rem < alloc*0.2) span.classList.add('warn');
  else span.classList.add('safe');
}

function updateWeeklyRemainingForInput(inp){
  const alloc = parseFloat(inp.dataset.alloc || '0') || 0;
  const val = parseFloat(inp.value || '0') || 0;
  const rem = alloc - val;
  const span = inp.parentElement.querySelector('[data-remaining]');
  if (span) setRemainingSpan(span, rem, alloc);
}

function initWeeklyRemaining(){
  document.querySelectorAll('#weekly-view input.week-punch').forEach(inp=>{
    updateWeeklyRemainingForInput(inp);
    inp.addEventListener('input', () => updateWeeklyRemainingForInput(inp));
  });
}

function updateDailyRemaining(){
  const groups = {};
  document.querySelectorAll('#daily-view tr[data-weeknum]').forEach(tr=>{
    const allocId = tr.dataset.allocation;
    const wk = tr.dataset.weeknum;
    const key = allocId + '|' + wk;
    const allocCell = tr.querySelector('td:nth-child(2)');
    const alloc = parseFloat((allocCell && allocCell.textContent) || '0') || 0;
    const inp = tr.querySelector('input.daily-input');
    const val = parseFloat((inp && inp.value) || '0') || 0;
    if (!groups[key]) groups[key] = {alloc: alloc, sum: 0, inputs: []};
    groups[key].sum += val;
    if (inp) groups[key].inputs.push(inp);
  });
  Object.values(groups).forEach(g=>{
    const rem = g.alloc - g.sum;
    g.inputs.forEach(inp=>{
      const span = inp.parentElement.querySelector('[data-remaining]');
      if (span) setRemainingSpan(span, rem, g.alloc);
    });
  });
}

function initDailyRemaining(){
  document.querySelectorAll('#daily-view input.daily-input').forEach(inp=>{
    inp.addEventListener('input', updateDailyRemaining);
  });
  updateDailyRemaining();
}

document.addEventListener('DOMContentLoaded', function(){
  initWeeklyRemaining();
  initDailyRemaining();
});

document.getElementById('btn-weekly').addEventListener('click', function(){
  document.getElementById('weekly-view').style.display = '';
  document.getElementById('daily-view').style.display = 'none';
  this.classList.add('active'); document.getElementById('btn-daily').classList.remove('active');
});
document.getElementById('btn-daily').addEventListener('click', function(){
  document.getElementById('weekly-view').style.display = 'none';
  document.getElementById('daily-view').style.display = '';
  this.classList.add('active'); document.getElementById('btn-weekly').classList.remove('active');
});

// Save weekly punches
document.addEventListener('click', function(ev){
  if(!ev.target.matches('.btn-save-week')) return;
  const tr = ev.target.closest('tr[data-allocation]');
  const allocationId = Number(tr.dataset.allocation);
  const inputs = Array.from(tr.querySelectorAll('input.week-punch'));
  const payloads = inputs.map(inp => ({week_number: Number(inp.dataset.week), actual_hours: parseFloat(inp.value||'0')}));
  if(!confirm('Save weekly punches for this allocation?')) return;
  let i=0;
  function sendNext(){
    if(i>=payloads.length){ alert('Saved weekly punches'); location.reload(); return; }
    fetch("{% url 'projects:save_my_alloc_weekly' %}", {
      method:'POST', credentials:'same-origin',
      headers:{'Content-Type':'application/json','X-CSRFToken':CSRFTOKEN},
      body:JSON.stringify({allocation_id:allocationId, week_number:payloads[i].week_number, actual_hours:payloads[i].actual_hours})
    }).then(r=>r.json()).then(j=>{ if(j&&j.ok){i++;sendNext();} else{alert('Error: '+(j.error||JSON.stringify(j)));} })
    .catch(err=>alert('Save failed: '+err));
  }
  sendNext();
});

// Save daily punches
document.addEventListener('click', function(ev){
  if(!ev.target.matches('.btn-save-daily')) return;
  const panel = ev.target.closest('div[style*="margin-top:18px"]');
  const rows = Array.from(panel.querySelectorAll('tr[data-date]'));
  const allocationId = Number(panel.querySelector('tr[data-allocation]').dataset.allocation);
  const tasks=[];
  rows.forEach(tr=>{
    const inp=tr.querySelector('input.daily-input');
    const date=tr.dataset.date;
    const val=parseFloat(inp.value||'0');
    const existing=parseFloat(tr.querySelector('.existing-punch').innerText||'0');
    if(val!==existing){tasks.push({punch_date:date, actual_hours:val});}
  });
  if(tasks.length===0){alert('No changes');return;}
  if(!confirm('Save daily punches for this project?'))return;
  let i=0;
  function sendOne(){
    if(i>=tasks.length){alert('Saved daily punches');location.reload();return;}
    const t=tasks[i];
    fetch("{% url 'projects:save_my_alloc_daily' %}", {
      method:'POST', credentials:'same-origin',
      headers:{'Content-Type':'application/json','X-CSRFToken':CSRFTOKEN},
      body:JSON.stringify({allocation_id:allocationId,punch_date:t.punch_date,actual_hours:t.actual_hours})
    }).then(r=>r.json()).then(j=>{ if(j&&j.ok){i++;sendOne();} else{alert('Error: '+(j.error||JSON.stringify(j)));} })
    .catch(err=>alert('Save failed: '+err));
  }
  sendOne();
});
</script>
{% endblock %}
