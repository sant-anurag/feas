{% extends "base.html" %}
{% load static %}
{% load dict_get %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<link rel="stylesheet" href="{% static 'css/team_allocations.css' %}">
<style>
/* layout */
.container { max-width:1200px; margin:18px auto; }
.panel { background:#fff; border-radius:10px; padding:18px; box-shadow:0 8px 20px rgba(2,6,23,0.04); }

/* top controls */
.controls-row { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
.page-controls { display:flex; gap:12px; align-items:center; justify-content:flex-end; }
.control-card { display:inline-flex; gap:10px; align-items:center; padding:8px 12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,255,0.85)); border:1px solid rgba(15,23,42,0.04); box-shadow:0 6px 18px rgba(12,36,75,0.06); }
.input-month { min-width:150px; padding:8px 10px; border-radius:10px; border:1px solid rgba(203,213,225,0.8); background:linear-gradient(180deg,#ffffff,#fbfdff); font-size:14px; }
.btn-load { background: linear-gradient(90deg, #1e3a8a 0%, #2563eb 60%); color: #fff; padding: 9px 16px; border-radius: 10px; font-weight:700; border:none; cursor:pointer; box-shadow:0 8px 20px rgba(37,99,235,0.18); }

/* toggles */
.toggle-controls { display:flex; gap:8px; margin-bottom:12px; }
.btn-toggle { padding:8px 12px; border-radius:8px; border:1px solid #e6eaf0; background:#fff; cursor:pointer; font-weight:700; }
.btn-toggle.active { background:linear-gradient(90deg,#2563eb,#1e40af); color:#fff; border:none; box-shadow:0 8px 20px rgba(37,99,235,0.12); }

/* compact weekly-per-project table */
.alloc-card { margin-top:12px; border-radius:10px; padding:14px; background:#fbfdff; border:1px solid #eef2f7; }
.project-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:12px; }
.project-title { font-weight:700; }
.small-muted { color:#6b7280; font-size:13px; }

/* vertical weeks table (CW rows) */
.weeks-table { width:100%; border-collapse:collapse; margin-top:6px; }
.weeks-table th, .weeks-table td { padding:8px 10px; border-bottom:1px solid #eef2f7; text-align:left; vertical-align:middle; }
.weeks-table thead th { background:#f8fafc; font-weight:700; color:#374151; }

/* daily view styles */
.daily-grid { width:100%; border-collapse:collapse; margin-top:12px; }
.daily-grid th, .daily-grid td { padding:8px; border-bottom:1px solid #f3f4f6; vertical-align:middle; }
.day-disabled { color:#9aa3b2; background:#fafafa; }

/* inputs and remaining */
.input-small { width:84px; padding:6px; border-radius:6px; border:1px solid #d1d5db; text-align:center; } /* center numeric inputs */
.remaining { font-size:12px; font-weight:700; padding:3px 6px; border-radius:6px; display:inline-block; margin-left:8px; }
.remaining.safe { background: rgba(16,185,129,0.12); color: #065f46; }
.remaining.warn { background: rgba(245,158,11,0.12); color:#92400e; }
.remaining.over { background: rgba(239,68,68,0.12); color:#991b1b; }

/* week-summary (daily view) */
.week-summary { display:flex; gap:12px; align-items:center; margin-bottom:6px; }
.week-summary .badge { padding:6px 10px; border-radius:8px; background:#f8fafc; font-weight:700; color:#1f2937; }
.week-summary.over { background:#fee2e2; color:#9f1239; }

/* save button disabled state */
.btn-save-daily[disabled] { opacity:0.5; cursor:not-allowed; }

/* ------------------ NEW LAYOUT ADJUSTMENTS ------------------ */

/* Widen WBS select so seller/buyer labels fit comfortably */
.wbs-select, select.input-small.wbs-select {
  min-width:160px;            /* make dropdown wider */
  max-width:280px;
  padding:6px 8px;
  font-size:13px;
  border-radius:6px;
  border:1px solid #d1d5db;
  background:#fff;
}

/* Align select and numeric input horizontally neatly */
.alloc-card .wbs-select + .input-small,
.alloc-card .input-small + .wbs-select {
  margin-left:6px;
}

/* Center-align key columns in weekly table:
   - column 2: Allocated
   - column 3: Punched
   - column 4: Enter Punch
*/
.weeks-table th:nth-child(2), .weeks-table td:nth-child(2),
.weeks-table th:nth-child(3), .weeks-table td:nth-child(3),
.weeks-table th:nth-child(4), .weeks-table td:nth-child(4) {
  text-align:center;
}

/* Center align the primary daily columns:
   - 2nd column (Week Alloc), 3rd (Punched), 4th (Enter Punch)
*/
.daily-grid th:nth-child(2), .daily-grid td:nth-child(2),
.daily-grid th:nth-child(3), .daily-grid td:nth-child(3),
.daily-grid th:nth-child(4), .daily-grid td:nth-child(4) {
  text-align:center;
}

/* Make table cells that contain the WBS + input have a small flexible layout */
.daily-grid td > div, .weeks-table td > div {
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:8px;
}

/* Improve appearance on narrow screens: allow horizontal scroll if table overflows */
@media (max-width: 1100px) {
  .weeks-table, .daily-grid {
    display:block;
    overflow-x:auto;
    white-space:nowrap;
  }
  .input-small { min-width:72px; }
  .wbs-select { min-width:140px; }
}

/* Slight visual improvement for the WBS select when focused */
.wbs-select:focus { box-shadow: 0 4px 12px rgba(37,99,235,0.12); outline: none; border-color: #2563eb; }

/* ensure remaining badges are centered in those cells too */
.weeks-table td span.remaining, .daily-grid td span.remaining { display:inline-block; min-width:56px; text-align:center; }

    /* ===== WBS, input centering and widths ===== */
.wbs-select {
  min-width: 180px;   /* wider dropdown so buyer/seller labels fit */
  max-width: 340px;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  background: #fff;
  font-size: 13px;
  text-align: left;   /* option text left, select box centered in cell */
  box-sizing: border-box;
}

/* center numeric inputs and make them visually compact */
.input-small {
  width: 84px;
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  text-align: center;
  background:#fff;
}

/* center important numeric columns */
.weeks-table th:nth-child(2), .weeks-table td:nth-child(2),
.weeks-table th:nth-child(3), .weeks-table td:nth-child(3),
.daily-grid th:nth-child(2), .daily-grid td:nth-child(2),
.daily-grid th:nth-child(3), .daily-grid td:nth-child(3),
.daily-grid th:nth-child(4), .daily-grid td:nth-child(4),
.daily-grid th:nth-child(5), .daily-grid td:nth-child(5) {
  text-align: center;
}

/* ensure the WBS select + input stack/center nicely inside their column */
.daily-grid td > div, .weeks-table td > div {
  display: flex;
  align-items: center;
  justify-content: center; /* center column content */
  gap: 10px;
}

/* ===== hover/pop effect for week cards ===== */
.alloc-card {
  transition: transform .18s ease, box-shadow .18s ease;
  will-change: transform;
}
.alloc-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 18px 40px rgba(16,24,40,0.12);
}

/* ===== polished gradient for save buttons ===== */
.btn-save-week, .btn-save-daily {
  background: linear-gradient(90deg,#0ea5e9,#2563eb);
  color: #fff;
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  font-weight: 700;
  box-shadow: 0 10px 22px rgba(37,99,235,0.14);
  cursor: pointer;
}
.btn-save-week:hover, .btn-save-daily:hover { transform: translateY(-2px); }

</style>

{% endblock %}

{% block content %}
<div class="container">
  <div class="panel" role="main" aria-labelledby="myAllocTitle">
    <div class="controls-row">
      <div>
        <h2 id="myAllocTitle">My Allocations — {{ month_start|date:"F Y" }}</h2>
        <p class="small-muted">Toggle between Weekly and Daily punching views. You cannot punch more than the allocated hours for the week.</p>
      </div>

      <div class="page-controls" aria-label="Month controls">
        <form method="get" class="control-card" style="align-items:center;">
          <label class="ctrl-label small-muted" style="margin-right:6px;">Select month</label>
          <input class="input-month" type="month" name="month" value="{{ month_start|date:'Y-m' }}">
          <button class="btn-load" type="submit">Load</button>
        </form>
      </div>
    </div>

    <div class="toggle-controls" role="tablist" aria-label="View toggle">
      <button id="btn-weekly" class="btn-toggle active" role="tab" aria-selected="true">Weekly View</button>
      <button id="btn-daily" class="btn-toggle" role="tab" aria-selected="false">Daily View</button>
    </div>

    {# ---------------- WEEKLY VIEW ---------------- #}
    <div id="weekly-view" role="tabpanel" aria-labelledby="btn-weekly">
      {% if not rows %}
        <div style="padding:18px;border-radius:8px;background:#fff;">No allocations found for you this month.</div>
      {% else %}
        {% for r in rows %}
          <div class="alloc-card" data-allocation="{{ r.allocation_id }}">
            <div class="project-head">
              <div class="project-title">{{ r.project_name }} — <span class="small-muted">{{ r.domain_name }}</span></div>
              <div class="small-muted">Total Alloc: {{ r.total_hours }}</div>
            </div>

            <table class="weeks-table" aria-describedby="CW table for {{ r.allocation_id }}">
            <thead>
              <tr>
                <th style="width:64px">CW#</th>
                <th style="width:120px">Allocated</th>
                <th style="width:120px">Punched</th>
                <th style="min-width:260px">WBS — Enter Punch</th>
                <th style="width:120px">Remaining</th>
              </tr>
            </thead>

              <tbody>
                <!-- week 1 -->
                <tr data-week="1">
                  <td>1</td>
                  <td>{{ r.w1_alloc_hours }}</td>
                  <td class="punched">{{ r.w1_punched_hours }}</td>
                  <td>
                    <div style="display:flex;align-items:center;gap:6px;">
                      {% if r.wbs_options %}
                        <select class="input-small wbs-select" data-week="1">
                          {% for opt in r.wbs_options %}
                            <option value="{{ opt.code }}">{{ opt.label }}</option>
                          {% endfor %}
                        </select>
                      {% endif %}
                      <input class="input-small week-punch" type="number" min="0" step="0.25"
                       data-week="1" value="{{ r.w1_punched_hours }}" data-alloc="{{ r.w1_alloc_hours }}">
                      <span class="remaining" data-remaining></span>
                    </div>
                  </td>
                  <td><span class="remaining" data-remaining></span></td>
                </tr>
                <!-- week 2 -->
                <tr data-week="2">
                  <td>2</td>
                  <td>{{ r.w2_alloc_hours }}</td>
                  <td class="punched">{{ r.w2_punched_hours }}</td>
                  <td>
                    <div style="display:flex;align-items:center;gap:6px;">
                      {% if r.wbs_options %}
                        <select class="input-small wbs-select" data-week="2">
                          {% for opt in r.wbs_options %}
                            <option value="{{ opt.code }}">{{ opt.label }}</option>
                          {% endfor %}
                        </select>
                      {% endif %}
                      <input class="input-small week-punch" type="number" min="0" step="0.25"
                       data-week="2" value="{{ r.w2_punched_hours }}" data-alloc="{{ r.w2_alloc_hours }}">
                      <span class="remaining" data-remaining></span>
                    </div>
                  </td>
                  <td><span class="remaining" data-remaining></span></td>
                </tr>
                <!-- week 3 -->
                <tr data-week="3">
                  <td>3</td>
                  <td>{{ r.w3_alloc_hours }}</td>
                  <td class="punched">{{ r.w3_punched_hours }}</td>
                  <td>
                    <div style="display:flex;align-items:center;gap:6px;">
                      {% if r.wbs_options %}
                        <select class="input-small wbs-select" data-week="3">
                          {% for opt in r.wbs_options %}
                            <option value="{{ opt.code }}">{{ opt.label }}</option>
                          {% endfor %}
                        </select>
                      {% endif %}
                      <input class="input-small week-punch" type="number" min="0" step="0.25"
                       data-week="3" value="{{ r.w3_punched_hours }}" data-alloc="{{ r.w3_alloc_hours }}">
                      <span class="remaining" data-remaining></span>
                    </div>
                  </td>
                  <td><span class="remaining" data-remaining></span></td>
                </tr>
                <!-- week 4 -->
                <tr data-week="4">
                  <td>4</td>
                  <td>{{ r.w4_alloc_hours }}</td>
                  <td class="punched">{{ r.w4_punched_hours }}</td>
                  <td>
                    <div style="display:flex;align-items:center;gap:6px;">
                      {% if r.wbs_options %}
                        <select class="input-small wbs-select" data-week="4">
                          {% for opt in r.wbs_options %}
                            <option value="{{ opt.code }}">{{ opt.label }}</option>
                          {% endfor %}
                        </select>
                      {% endif %}
                      <input class="input-small week-punch" type="number" min="0" step="0.25"
                       data-week="4" value="{{ r.w4_punched_hours }}" data-alloc="{{ r.w4_alloc_hours }}">
                      <span class="remaining" data-remaining></span>
                    </div>
                  </td>
                  <td><span class="remaining" data-remaining></span></td>
                </tr>
              </tbody>
            </table>

            <div style="text-align:right; margin-top:8px;">
              <button class="btn btn-save-week">Save Week</button>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    {# ---------------- DAILY VIEW ---------------- #}
    <div id="daily-view" role="tabpanel" aria-labelledby="btn-daily" style="display:none; margin-top:12px;">
      {% if not rows %}
        <div style="padding:18px;border-radius:8px;background:#fff;">No allocations found for you this month.</div>
      {% else %}
        <p class="small-muted">Daily punching: only weekdays (Mon–Fri) are editable. Weekly totals are validated on Save.</p>

        {% for r in rows %}
          <div class="alloc-card" data-allocation="{{ r.allocation_id }}">
            <div class="project-head">
              <div class="project-title">{{ r.project_name }} — <span class="small-muted">{{ r.domain_name }}</span></div>
              <div class="small-muted">Total Alloc: {{ r.total_hours }}</div>
            </div>

            {% regroup daily_dates by week_number as weeks %}
            {% for week in weeks %}
              <div style="margin-top:12px;">
                <div class="week-summary" data-week="{{ week.grouper }}">
                  {% if week.grouper == 1 %}<div class="badge">W{{ week.grouper }} Alloc: {{ r.w1_alloc_hours }}</div>{% endif %}
                  {% if week.grouper == 2 %}<div class="badge">W{{ week.grouper }} Alloc: {{ r.w2_alloc_hours }}</div>{% endif %}
                  {% if week.grouper == 3 %}<div class="badge">W{{ week.grouper }} Alloc: {{ r.w3_alloc_hours }}</div>{% endif %}
                  {% if week.grouper == 4 %}<div class="badge">W{{ week.grouper }} Alloc: {{ r.w4_alloc_hours }}</div>{% endif %}
                  <div class="small-muted">Punched (week): <span class="week-punched">None</span></div>
                  <div class="small-muted">Remaining: <span class="week-remaining">0.00</span></div>
                </div>

                <table class="daily-grid">
                  <thead>
                      <tr>
                        <th style="width:180px">Date</th>
                        <th style="width:120px">Week Alloc</th>
                        <th style="width:120px">Punched</th>
                        <th style="min-width:220px">WBS</th>
                        <th style="width:120px">Enter Punch</th>
                      </tr>
                    </thead>

                  <tbody>
                    {% for d in week.list %}
                      {% with ds=d.iso %}
                      <tr data-date="{{ ds }}" data-weeknum="{{ d.week_number }}"
                          class="{% if d.is_weekend or holidays_map|dict_get:ds %}day-disabled{% endif %}"
                          title="{% if holidays_map|dict_get:ds %}Holiday: {{ holidays_map|dict_get:ds }}{% endif %}">
                        <td>{{ d.date|date:"D, d M" }}</td>
                        <td>
                          {% if d.week_number == 1 %}{{ r.w1_alloc_hours }}
                          {% elif d.week_number == 2 %}{{ r.w2_alloc_hours }}
                          {% elif d.week_number == 3 %}{{ r.w3_alloc_hours }}
                          {% else %}{{ r.w4_alloc_hours }}
                          {% endif %}
                        </td>
                        <td class="existing-punch">
                          {{ daily_map|dict_get:r.allocation_id|dict_get:ds }}
                        </td>
                        {# WBS column #}
                        <td>
                          {% if d.is_weekend or holidays_map|dict_get:ds %}
                            <div style="text-align:center;"><em class="small-muted">N/A</em></div>
                          {% else %}
                            <div>
                              {% if r.wbs_options %}
                                <select class="wbs-select" data-date="{{ ds }}">
                                  {% for opt in r.wbs_options %}
                                    <option value="{{ opt.code }}">{{ opt.label }}</option>
                                  {% endfor %}
                                </select>
                              {% else %}
                                <div class="small-muted">—</div>
                              {% endif %}
                            </div>
                          {% endif %}
                        </td>

                        {# Enter punch column #}
                        <td>
                          {% if d.is_weekend or holidays_map|dict_get:ds %}
                            <input class="input-small daily-input" type="number" disabled value="{{ daily_map|dict_get:r.allocation_id|dict_get:ds }}" />
                          {% else %}
                            <div>
                              <input class="input-small daily-input" type="number" min="0" step="0.25"
                                     value="{{ daily_map|dict_get:r.allocation_id|dict_get:ds }}"
                                     data-date="{{ ds }}" data-weeknum="{{ d.week_number }}" />
                              <span class="remaining" data-remaining></span>
                            </div>
                          {% endif %}
                        </td>


                      </tr>
                      {% endwith %}
                    {% endfor %}
                  </tbody>
                </table>

                <div style="text-align:right; margin-top:6px;">
                  <button class="btn btn-save-daily" data-week="{{ week.grouper }}">Save Week {{ week.grouper }} Punches</button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  try {
    // find controls
    const btnWeekly = document.getElementById('btn-weekly');
    const btnDaily = document.getElementById('btn-daily');
    const weeklyView = document.getElementById('weekly-view');
    const dailyView = document.getElementById('daily-view');

    if (!btnWeekly || !btnDaily || !weeklyView || !dailyView) {
      console.warn('My Allocations: toggle elements missing', { btnWeekly, btnDaily, weeklyView, dailyView });
      return;
    }

    // ensure buttons don't submit parent forms by accident
    btnWeekly.setAttribute('type', 'button');
    btnDaily.setAttribute('type', 'button');

    function showView(view) {
      if (view === 'weekly') {
        weeklyView.style.display = '';
        dailyView.style.display = 'none';
        btnWeekly.classList.add('active');
        btnDaily.classList.remove('active');
        btnWeekly.setAttribute('aria-selected', 'true');
        btnDaily.setAttribute('aria-selected', 'false');
      } else {
        weeklyView.style.display = 'none';
        dailyView.style.display = '';
        btnWeekly.classList.remove('active');
        btnDaily.classList.add('active');
        btnWeekly.setAttribute('aria-selected', 'false');
        btnDaily.setAttribute('aria-selected', 'true');
      }
    }

    // Attach handlers
    btnWeekly.addEventListener('click', function (e) {
      e.preventDefault();
      showView('weekly');
      try { localStorage.setItem('myAlloc_view', 'weekly'); } catch(e){}
    });

    btnDaily.addEventListener('click', function (e) {
      e.preventDefault();
      showView('daily');
      try { localStorage.setItem('myAlloc_view', 'daily'); } catch(e){}
    });

    // optionally respect last selected tab from localStorage
    try {
      const last = localStorage.getItem('myAlloc_view') || 'weekly';
      showView(last);
    } catch (err) {
      // ignore storage errors in private mode
    }

    // expose for debugging in console
    window.myAllocShowView = showView;

  } catch (err) {
    console.error('My Allocations toggle init failed', err);
  }
});
</script>

<script>
/* Helper */
function getCookie(name){ const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v?v.pop():''; }
const CSRFTOKEN = getCookie('csrftoken');

function setBadge(el, rem, alloc){
  el.textContent = parseFloat(rem).toFixed(2);
  el.classList.remove('safe','warn','over');
  if(rem < 0) el.classList.add('over');
  else if(rem < alloc*0.2) el.classList.add('warn');
  else el.classList.add('safe');
}

/* ---------- WEEKLY view remaining (vertical rows) ---------- */
function initWeeklyCard(card){
  // for each week input compute remaining = alloc - inputValue
  const inputs = card.querySelectorAll('input.week-punch');
  inputs.forEach(inp=>{
    function update(){
      const alloc = parseFloat(inp.dataset.alloc||'0')||0;
      const val = parseFloat(inp.value||'0')||0;
      const rem = alloc - val;
      // remaining span in same row (we have two per row; pick the first)
      const row = inp.closest('tr');
      const span = row.querySelector('span[data-remaining]') || row.querySelector('[data-remaining]');
      if(span) setBadge(span, rem, alloc);
    }
    update();
    inp.addEventListener('input', update);
  });
}

document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.alloc-card').forEach(initWeeklyCard);
});

/* ---------- DAILY view: weekly totals, weekend disabling and save control ---------- */

function computeWeekSummaryForAllocation(card, weekNum){
  // find all rows for this week inside this card
  const rows = Array.from(card.querySelectorAll('tr[data-weeknum="'+weekNum+'"]'));
  if(rows.length === 0) return {alloc:0, sum:0};
  const allocText = rows[0].cells[1].textContent.trim() || "0";
  const alloc = parseFloat(allocText) || 0;
  let sum = 0.0;
  rows.forEach(r=>{
    const inp = r.querySelector('input.daily-input');
    if(inp && !inp.disabled){
      sum += parseFloat(inp.value||'0') || 0;
    }
  });
  return {alloc: alloc, sum: sum};
}

function updateDailySummaries(){
  // iterate each alloc card
  document.querySelectorAll('.alloc-card').forEach(card=>{
    const weekContainers = card.querySelectorAll('.week-summary');
    weekContainers.forEach(ws=>{
      const weekNum = ws.dataset.week;
      const summary = computeWeekSummaryForAllocation(card, weekNum);
      const punchedEl = ws.querySelector('.week-punched');
      const remEl = ws.querySelector('.week-remaining');
      if(punchedEl) punchedEl.textContent = summary.sum.toFixed(2);
      if(remEl){
        const rem = summary.alloc - summary.sum;
        remEl.textContent = rem.toFixed(2);
        if(rem < 0) ws.classList.add('over'); else ws.classList.remove('over');
      }
      const saveBtn = card.querySelector('.btn-save-daily[data-week="'+weekNum+'"]');
      if(saveBtn){
        if(summary.sum > summary.alloc) saveBtn.setAttribute('disabled','disabled'); else saveBtn.removeAttribute('disabled');
      }
    });
  });
}

document.addEventListener('input', function(ev){
  if(ev.target && ev.target.matches('input.daily-input')){
    updateDailySummaries();
  }
});

document.addEventListener('DOMContentLoaded', function(){
  updateDailySummaries();
});

/* ---------- Save endpoints (include WBS) ---------- */

// Save weekly punches (vertical weekly card): this saves all 4 week inputs for the allocation
document.addEventListener('click', function(ev){
  if(!ev.target.matches('.btn-save-week')) return;
  const card = ev.target.closest('.alloc-card');
  const allocationId = card.dataset.allocation;
  const inputs = Array.from(card.querySelectorAll('input.week-punch'));
  // for each input determine week and related wbs-select (data-week)
  const payloads = inputs.map(i=>{
    const wk = Number(i.dataset.week);
    const wbsSel = card.querySelector('.wbs-select[data-week="'+wk+'"]') || card.querySelector('.wbs-select');
    const wbs = wbsSel ? wbsSel.value : null;
    return { week_number: wk, actual_hours: parseFloat(i.value||'0')||0, wbs: wbs };
  });

  if(!confirm('Save weekly punches for this allocation?')) return;
  let i = 0;
  function sendNext(){
    if(i >= payloads.length){ alert('Saved'); location.reload(); return; }
    const p = payloads[i];
    fetch("{% url 'projects:save_my_alloc_weekly' %}", {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRFTOKEN},
      body: JSON.stringify({ allocation_id: Number(allocationId), week_number: p.week_number, actual_hours: p.actual_hours, wbs: p.wbs })
    }).then(r=>r.json()).then(j=>{
      if(j && j.ok){ i++; sendNext(); } else { alert('Error: '+(j && j.error? j.error : JSON.stringify(j))); }
    }).catch(err=>{ alert('Save failed: '+err); });
  }
  sendNext();
});

// Save daily punches for a particular allocation-week (Save button exists per week inside each card)
document.addEventListener('click', function(ev){
  if(!ev.target.matches('.btn-save-daily')) return;
  const btn = ev.target;
  const weekNum = btn.dataset.week;
  const card = btn.closest('.alloc-card');
  const allocationId = Number(card.dataset.allocation);
  const rows = Array.from(card.querySelectorAll('tr[data-weeknum="'+weekNum+'"]'));
  const tasks = [];
  rows.forEach(r=>{
    const inp = r.querySelector('input.daily-input:not([disabled])');
    if(!inp) return;
    const date = r.dataset.date;
    const val = parseFloat(inp.value||'0')||0;
    const existing = parseFloat(r.querySelector('.existing-punch').textContent||'0')||0;
    if(val !== existing){
      // prefer date-specific wbs select, otherwise card-level
      const wbsSel = card.querySelector('.wbs-select[data-date="'+date+'"]') || card.querySelector('.wbs-select');
      const wbs = wbsSel ? wbsSel.value : null;
      tasks.push({ punch_date: date, actual_hours: val, wbs: wbs });
    }
  });
  if(tasks.length === 0){ alert('No changes to save for this week'); return; }
  if(!confirm('Save daily punches for week '+weekNum+'?')) return;
  const summary = computeWeekSummaryForAllocation(card, weekNum);
  if(summary.sum > summary.alloc){ alert('Weekly total exceeds allocation, fix before saving'); return; }

  let idx = 0;
  function sendOne(){
    if(idx >= tasks.length){ alert('Saved daily punches'); location.reload(); return; }
    const t = tasks[idx];
    fetch("{% url 'projects:save_my_alloc_daily' %}", {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRFTOKEN},
      body: JSON.stringify({ allocation_id: allocationId, punch_date: t.punch_date, actual_hours: t.actual_hours, wbs: t.wbs })
    }).then(r=>r.json()).then(j=>{
      if(j && j.ok){ idx++; sendOne(); } else { alert('Failed to save '+t.punch_date+': '+(j.error || JSON.stringify(j))); }
    }).catch(err=>{ alert('Save failed: '+err); });
  }
  sendOne();
});
</script>
{% endblock %}
