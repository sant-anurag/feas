{% extends "base.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<link rel="stylesheet" href="{% static 'projects/css/projects-actions.css' %}">
{% endblock %}

{% block content %}
<div style="display:flex;gap:28px;align-items:flex-start;flex-wrap:wrap;">
  <!-- LEFT: Create Project FORM -->
  <div style="flex:0 0 620px;min-width:320px;">
    <div class="panel" style="padding:26px;">
      <h2 style="margin:0 0 14px 0">Create Project</h2>

      {% if error %}
        <div role="alert" style="color:#b91c1c;margin-bottom:12px;font-weight:700">{{ error }}</div>
      {% endif %}

      <form method="post" class="form-grid" style="margin-top:6px;">
        {% csrf_token %}
        <label>
          <div style="font-weight:700;margin-bottom:8px">Project Name</div>
          <input type="text" name="name" required class="form-input" placeholder="Enter project name" />
        </label>

        <label>
          <div style="font-weight:700;margin-bottom:8px">Description</div>
          <textarea name="description" rows="4" class="form-input" placeholder="Short description"></textarea>
        </label>

        <div style="display:flex;gap:14px;">
          <label style="flex:1">
            <div style="font-weight:700;margin-bottom:8px">Start Date</div>
            <input type="date" name="start_date" class="form-input" />
          </label>
          <label style="flex:1">
            <div style="font-weight:700;margin-bottom:8px">End Date</div>
            <input type="date" name="end_date" class="form-input" />
          </label>
        </div>

        <label>
          <div style="font-weight:700;margin-bottom:8px">Program Development Lead (PDL)</div>
          <!-- visible autocomplete input + hidden field for sAMAccountName -->
          <input id="pdl_picker" name="pdl_display" type="text" class="form-input" placeholder="Type at least 3 chars to search LDAP..." autocomplete="off"/>
          <input id="pdl_username" name="pdl_username" type="hidden" value=""/>
          <div id="pdl_suggestions" class="autocomplete-list" aria-hidden="true"></div>
        </label>

        <div class="form-actions" style="margin-top:6px;">
          <a href="{% url 'projects:list' %}" class="btn secondary" style="text-decoration:none">Cancel</a>
          <button type="submit" class="btn primary">Create Project</button>
        </div>
      </form>
    </div>
  </div>

  <!-- RIGHT: Action Panel -->
  <div style="flex:1;min-width:320px;">
    <div class="actions-panel">
      <h3 style="margin:0 0 14px 0">Project Actions</h3>

      <!-- COE Departments card -->
      <div class="action-card">
        <div class="card-title">COE Departments</div>
        <div class="card-body card-body--grid">
          <a href="#" class="action-card-btn" data-open="coeCreateModal" title="Create COE">
            <span class="acb-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="2" y="3" width="20" height="18" rx="3" fill="#fff" opacity="0.02"/><path d="M12 8v8M8 12h8" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            <span class="acb-label">Create COE</span>
          </a>

          <a href="#" class="action-card-btn action-card-btn--ghost" data-open="coeListModal" title="Edit COE">
            <span class="acb-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M14.7 6.3l3 3" stroke="#0b1320" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            <span class="acb-label">Edit COE</span>
          </a>
        </div>
      </div>

      <!-- COE Leaders card -->
      <div class="action-card">
        <div class="card-title">COE Leaders</div>
        <div class="card-body card-body--grid">
          <a href="#" class="action-card-btn" data-open="coeLeaderModal" title="Assign or edit COE leader">
            <span class="acb-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="3" stroke="#fff" stroke-width="1.6"/><path d="M6 20c1.5-3 4.5-4 6-4s4.5 1 6 4" stroke="#fff" stroke-width="1.2" stroke-linecap="round"/></svg>
            </span>
            <span class="acb-label">Assign / Edit Leader</span>
          </a>
        </div>
      </div>

      <!-- Domains -->
      <div class="action-card">
        <div class="card-title">Domains</div>
        <div class="card-body card-body--grid">
          <a href="#" class="action-card-btn" data-open="domainCreateModal" title="Create Domain">
            <span class="acb-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="16" rx="2" stroke="#fff" stroke-width="1.4"/><path d="M8 12h8" stroke="#fff" stroke-width="1.8" stroke-linecap="round"/></svg>
            </span>
            <span class="acb-label">Create Domain</span>
          </a>

          <a href="#" class="action-card-btn action-card-btn--ghost" data-open="domainEditModal" title="Edit Domain">
            <span class="acb-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M14.7 6.3l3 3" stroke="#0b1320" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            <span class="acb-label">Edit Domain</span>
          </a>
        </div>
      </div>

      <!-- Projects card -->
      <div class="action-card">
        <div class="card-title">Projects</div>
        <div class="card-body card-body--grid">
          <a href="{% url 'projects:list' %}" class="action-card-btn" title="View project list">
            <span class="acb-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 7h18M7 12h10M5 17h14" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/></svg>
            </span>
            <span class="acb-label">View Project List</span>
          </a>

          <a href="#" class="action-card-btn action-card-btn--ghost" onclick="window.scrollTo({top:0,behavior:'smooth'});return false;" title="Edit project">
            <span class="acb-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M14.7 6.3l3 3" stroke="#0b1320" stroke-width="1.4"/></svg>
            </span>
            <span class="acb-label">Edit Project</span>
          </a>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ---------- Modals (hidden by default) ---------- -->

<!-- COE Create Modal -->
<div id="coeCreateModal" class="modal" aria-hidden="true" style="display:none;">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div class="modal-header">
      <strong>Create COE</strong>
      <button class="close-modal" data-close="coeCreateModal" aria-label="Close">✕</button>
    </div>

    <form method="post" action="{% url 'projects:coes_create' %}">
      {% csrf_token %}
      <div class="modal-body">
        <label>
          <div style="font-weight:700;margin-bottom:6px">COE Name</div>
          <input type="text" name="name" required class="form-input" />
        </label>

        <label>
          <div style="font-weight:700;margin-bottom:6px">COE Leader (search LDAP)</div>
          <input id="coe_leader_picker" type="text" class="form-input" placeholder="Type name or email..." autocomplete="off" />
          <input id="coe_leader_username" name="leader_username" type="hidden" />
          <div id="coe_leader_suggestions" class="autocomplete-list" aria-hidden="true"></div>
        </label>

        <label>
          <div style="font-weight:700;margin-bottom:6px">Description</div>
          <textarea name="description" rows="3" class="form-input"></textarea>
        </label>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn secondary" data-close="coeCreateModal">Cancel</button>
        <button type="submit" class="btn primary">Create COE</button>
      </div>
    </form>
  </div>
</div>

<!-- Domain Create Modal -->
<div id="domainCreateModal" class="modal" aria-hidden="true" style="display:none;">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div class="modal-header">
      <strong>Create Domain</strong>
      <button class="close-modal" data-close="domainCreateModal" aria-label="Close">✕</button>
    </div>

    <form method="post" action="{% url 'projects:domains_create' %}">
      {% csrf_token %}
      <div class="modal-body">
        <label>
          <div style="font-weight:700;margin-bottom:6px">Domain Name</div>
          <input type="text" name="name" required class="form-input" />
        </label>

        <label>
          <div style="font-weight:700;margin-bottom:6px">Parent COE</div>
          <select name="coe_id" class="form-input">
            <option value="">-- select COE --</option>
            {% for c in coes %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          <div style="font-weight:700;margin-bottom:6px">Domain Lead (search LDAP)</div>
          <input id="domain_lead_picker" type="text" class="form-input" placeholder="Type name or email..." autocomplete="off" />
          <input id="domain_lead_username" name="lead_username" type="hidden" />
          <div id="domain_lead_suggestions" class="autocomplete-list" aria-hidden="true"></div>
        </label>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn secondary" data-close="domainCreateModal">Cancel</button>
        <button type="submit" class="btn primary">Create Domain</button>
      </div>
    </form>
  </div>
</div>

<!-- COE Leader assign/edit modal (reuse create modal UI for simplicity) -->
<div id="coeLeaderModal" class="modal" aria-hidden="true" style="display:none;">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div class="modal-header">
      <strong>Assign / Edit COE Leader</strong>
      <button class="close-modal" data-close="coeLeaderModal" aria-label="Close">✕</button>
    </div>

    <form method="post" action="{% url 'projects:coes_edit' 0 %}" id="coeLeaderForm">
      {% csrf_token %}
      <div class="modal-body">
        <label>
          <div style="font-weight:700;margin-bottom:6px">Select COE</div>
          <select name="coe_id" class="form-input" id="coe_select_for_leader">
            <option value="">-- select COE --</option>
            {% for c in coes %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          <div style="font-weight:700;margin-bottom:6px">Leader (search LDAP)</div>
          <input id="coe_leader_picker_modal" type="text" class="form-input" placeholder="Type name or email..." autocomplete="off" />
          <input id="coe_leader_username_modal" name="leader_username" type="hidden" />
          <div id="coe_leader_suggestions_modal" class="autocomplete-list" aria-hidden="true"></div>
        </label>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn secondary" data-close="coeLeaderModal">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </div>
</div>

{% block extra_js %}
<script src="{% static 'projects/js/projects-actions.js' %}"></script>
<script>
  // Wire duplicate autocomplete pickers inside modal forms
  // projects-actions.js wires default IDs; if we have modal versions, wire them here after DOM ready
  document.addEventListener('DOMContentLoaded', function() {
    // In projects-actions.js we call wireAutocomplete for pdl_picker etc.
    // Ensure modal variant ids are also wired (projects-actions.js wires known ids).
    // If needed, we can call a global register function here. For now these IDs match the file.
  });
</script>
{% endblock %}

{% endblock %}
