{% extends "base.html" %}
{% load static %}
{% load dict_get %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<style>
.container { max-width:1200px; margin:18px auto; }
.resource-block { background:#fff; border-radius:10px; padding:14px; margin-bottom:18px; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
.resource-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.resource-title { font-weight:800; font-size:16px; color:#0b2447; }
.small-muted { color:#6b7280; font-size:13px; }
.team-table { width:100%; border-collapse:collapse; }
.team-table th, .team-table td { padding:10px 12px; border-bottom:1px solid #eef2f7; text-align:left; vertical-align:middle; }
.team-table thead th { background:#f8fafc; font-weight:700; color:#374151; }
.week-input { width:100px; padding:6px 8px; border-radius:6px; border:1px solid #e6eaf0; }
.actions { display:flex; gap:8px; align-items:center; }
.btn { padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
.btn-save { background:linear-gradient(90deg,#2563eb,#1e40af); color:#fff; border:none; }
.btn-reset { background:#fff; border:1px solid rgba(10,30,80,0.08); color:#0b1320; }

.controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
.control-item { display:flex; gap:8px; align-items:center; }

.no-allocs { background: #fff5f5; border: 1px solid #fde3e3; border-radius: 10px; padding: 12px; margin-top: 20px; }
.no-allocs table { width:100%; border-collapse:collapse; }
.no-allocs th, .no-allocs td { padding:8px 10px; border-bottom:1px solid #f8dcdc; text-align:left; vertical-align:middle; }
.no-allocs thead th { font-weight:700; color:#7f1d1d; background: transparent; }
.muted { color:#6b7280; font-size:12px; }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h2 style="margin:0;">Team Allocation — {{ month_start|date:"F Y" }}</h2>

    <form method="get" style="display:flex;gap:8px;align-items:center;">
      {# HTML5 month input produces YYYY-MM, aligns with server parsing #}
      <div class="control-item">
        <label class="small-muted" style="margin-right:6px;">Select month</label>
        <input type="month" name="month" value="{{ month_start|date:'Y-m' }}" style="padding:8px;border-radius:8px;border:1px solid #e6eaf0;">
      </div>
      <button class="btn btn-reset" type="submit">Load</button>
    </form>
  </div>

  {% if not rows %}
    <div class="panel" style="padding:18px;border-radius:10px;background:#fff;">
      No allocations found for your reportees for this month.
    </div>
  {% else %}
    {# Group rows by user_ldap (resource) #}
    {% regroup rows by user_ldap as resources %}
    {% for res in resources %}
      <div class="resource-block">
        <div class="resource-header">
          <div>
            <div class="resource-title">
              {{ res.grouper }} — {% if res.list.0.display_name %}{{ res.list.0.display_name }}{% else %}{{ res.list.0.username }}{% endif %}
            </div>
            <div class="small-muted">Reportee</div>
          </div>
          <div class="small-muted">Tip: enter weekly % values (0-100). Save per-row.</div>
        </div>

        <table class="team-table">
          <thead>
            <tr>
              <th style="width:260px">Project</th>
              <th style="width:180px">Domain</th>
              <th style="width:120px">Allocated Hrs</th>
              <th style="width:100px">Week 1 %</th>
              <th style="width:100px">Week 2 %</th>
              <th style="width:100px">Week 3 %</th>
              <th style="width:100px">Week 4 %</th>
              <th style="width:160px">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in res.list %}
              {% with w=weekly_map|dict_get:r.allocation_id %}
              <tr data-allocation="{{ r.allocation_id }}">
                <td>{{ r.project_name }}</td>
                <td>{{ r.domain_name }}</td>
                <td>{{ r.total_hours|floatformat:2 }}</td>

                {# weekly_map stores 'percent' per week in the view; show percent here #}
                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                             value="{{ w|dict_get:1|dict_get:'percent'|default:0 }}"
                             data-week="1"></td>

                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                             value="{{ w|dict_get:2|dict_get:'percent'|default:0 }}"
                             data-week="2"></td>

                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                             value="{{ w|dict_get:3|dict_get:'percent'|default:0 }}"
                             data-week="3"></td>

                <td><input class="week-input" type="number" min="0" max="100" step="0.01"
                             value="{{ w|dict_get:4|dict_get:'percent'|default:0 }}"
                             data-week="4"></td>

                <td class="actions">
                  <button class="btn btn-save" type="button">Save</button>
                  <button class="btn btn-reset" type="button">Reset</button>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% endif %}

  {# Reportees with no allocation — shown at bottom in a light-red table #}
  {% if reportees_no_alloc %}
    <div class="no-allocs">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="font-weight:800;color:#7f1d1d;">Reportees without allocations — {{ month_start|date:"F Y" }}</div>
        <div class="small-muted">You may want to create allocations for them.</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Resource (LDAP)</th>
            <th>Name / Email</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reportees_no_alloc %}
          <tr>
            <td>{{ r.ldap }}</td>
            <td>{% if r.display %}{{ r.display }}{% else %}—{% endif %}{% if r.email %} &lt;{{ r.email }}&gt;{% endif %}</td>
            <td>
              <a class="btn btn-reset" href="{% url 'projects:monthly_allocations' %}?project_id=&month={{ month_start|date:'Y-m' }}">Create allocation</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name){ const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v?v.pop():''; }

document.querySelectorAll('.btn-save').forEach(btn=>{
  btn.addEventListener('click', function(e){
    const tr = this.closest('tr');
    const allocation_id = tr.dataset.allocation;
    const weekly = {};
    tr.querySelectorAll('.week-input').forEach(inp=>{
      // use numeric strings / numbers; send as-is
      weekly[inp.dataset.week] = Number(inp.value || 0);
    });

    // validate total percentage per allocation row
    let totalPct = 0;
    Object.values(weekly).forEach(v=> totalPct += Number(v));
    if(totalPct > 100){
      if(!confirm("Total % > 100. Continue anyway?")) return;
    }

    fetch("{% url 'projects:save_team_allocation' %}", {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({allocation_id: Number(allocation_id), weekly: weekly})
    }).then(r=>r.json()).then(data=>{
      if(data.ok) {
        alert("Saved successfully!");
        // optionally reload weekly data for this row — for now reload entire page to reflect server-calculated hours
        location.reload();
      } else alert("Error: " + (data.error || JSON.stringify(data)));
    }).catch(err=>{
      alert("Save failed: " + err);
    });
  });
});

document.querySelectorAll('.btn-reset').forEach(btn=>{
  btn.addEventListener('click', function(e){
    location.reload();
  });
});
</script>
{% endblock %}
