{% extends "base.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<link rel="stylesheet" href="{% static 'projects/css/projects-actions.css' %}">
{% endblock %}

{% block content %}
<div class="page-shell">
  <div class="inner-grid">

    <!-- LEFT: Edit Project FORM -->
    <section class="edit-column panel card-elevated">
      <header class="card-header">
        <h2>Edit Project</h2>
      </header>

      {% if messages %}
        <div class="messages">
          {% for m in messages %}
            <div class="msg {{ m.tags }}">{{ m }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="post" id="editProjectForm" class="form-vertical">
        {% csrf_token %}
        <div class="form-row">
          <label class="field-label">Select project (you are the creator)</label>
          <select name="project_choice" id="project_choice" class="form-input" required>
            <option value="">-- Select project --</option>
            {% for p in editable_projects %}
              <option value="{{ p.id }}" {% if selected_project and selected_project.id == p.id %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-row">
          <label class="field-label">OEM Name</label>
          <input type="text" name="oem_name" id="oem_name" class="form-input" value="{{ selected_project.oem_name|default_if_none:'' }}">
        </div>

        <div class="form-row form-split">
          <div>
            <label class="field-label">Start Date</label>
            <input type="date" name="start_date" id="start_date" class="form-input" value="{{ selected_project.start_date|default_if_none:'' }}">
          </div>
          <div>
            <label class="field-label">End Date</label>
            <input type="date" name="end_date" id="end_date" class="form-input" value="{{ selected_project.end_date|default_if_none:'' }}">
          </div>
        </div>

        <div class="form-row">
          <label class="field-label">Program Development Lead (PDL)</label>
          <input id="pdl_picker" name="pdl_display" type="text" class="form-input" placeholder="Type at least 3 chars to search LDAP..." autocomplete="off"
                 value="{% if selected_project.pdl_name %}{{ selected_project.pdl_name }} ({{ selected_project.pdl_user_id|default_if_none:'' }}){% endif %}" />
          <input id="pdl_user_id" name="pdl_user_id" type="hidden" value="{% if selected_project.pdl_user_id %}{{ selected_project.pdl_user_id }}{% endif %}" />
          <input id="pdl_name" type="text" readonly class="form-input readonly" value="{{ selected_project.pdl_name|default_if_none:'' }}" />
          <div id="pdl_suggestions" class="autocomplete-list" aria-hidden="true"></div>
        </div>

        <div class="form-row">
          <label class="field-label">Project Manager (PM)</label>
          <input id="pm_picker" name="pm_display" type="text" class="form-input" placeholder="Type at least 3 chars to search LDAP..." autocomplete="off"
                 value="{% if selected_project.pm_name %}{{ selected_project.pm_name }} ({{ selected_project.pm_user_id|default_if_none:'' }}){% endif %}" />
          <input id="pm_user_id" name="pm_user_id" type="hidden" value="{% if selected_project.pm_user_id %}{{ selected_project.pm_user_id }}{% endif %}" />
          <input id="pm_name" type="text" readonly class="form-input readonly" value="{{ selected_project.pm_name|default_if_none:'' }}" />
          <div id="pm_suggestions" class="autocomplete-list" aria-hidden="true"></div>
        </div>

        <div class="form-row">
          <label class="field-label">Description</label>
          <textarea name="description" id="description" rows="4" class="form-input">{{ selected_project.description|default_if_none:'' }}</textarea>
        </div>

        <div class="form-actions" style="justify-content:flex-end;">
          <button type="button" id="resetBtn" class="btn btn-outline">Reset</button>
          <button type="submit" class="btn btn-primary">Edit Project</button>
        </div>
      </form>
    </section>

    <!-- RIGHT: Project Details -->
    <aside class="details-column">
      <div class="details-card card-elevated">
        <header class="card-header">
          <h3>Project Details</h3>
        </header>

        {% if selected_project %}
        <dl class="details-grid">
          <div class="kv">
            <dt>Name</dt>
            <dd class="mono">{{ selected_project.name }}</dd>
          </div>

          <div class="kv">
            <dt>OEM</dt>
            <dd>{{ selected_project.oem_name|default_if_none:"—" }}</dd>
          </div>

          <div class="kv">
            <dt>PDL</dt>
            <dd>
              {% if selected_project.pdl_name %}
                {{ selected_project.pdl_name }} <span class="muted">&lt;{{ selected_project.pdl_user_id }}&gt;</span>
              {% else %}
                — <span class="muted small">not set</span>
              {% endif %}
            </dd>
          </div>

          <div class="kv">
            <dt>PM</dt>
            <dd>
              {% if selected_project.pm_name %}
                {{ selected_project.pm_name }} <span class="muted">&lt;{{ selected_project.pm_user_id }}&gt;</span>
              {% else %}
                — <span class="muted small">not set</span>
              {% endif %}
            </dd>
          </div>

          <div class="kv">
            <dt>Start</dt>
            <dd>{{ selected_project.start_date|default_if_none:"—" }}</dd>
          </div>

          <div class="kv">
            <dt>End</dt>
            <dd>{{ selected_project.end_date|default_if_none:"—" }}</dd>
          </div>

          <div class="kv full">
            <dt>Description</dt>
            <dd class="prewrap">{{ selected_project.description|default_if_none:"—" }}</dd>
          </div>
        </dl>
        {% else %}
          <div class="muted" style="padding:18px">No project selected or no editable projects found for you.</div>
        {% endif %}

      </div> <!-- details-card -->
    </aside>

  </div> <!-- inner-grid -->
</div> <!-- page-shell -->

{% block extra_js %}
<script src="{% static 'projects/js/projects-actions.js' %}"></script>

<script>
(function(){
  // Reset simply reloads the selected project state
  const resetBtn = document.getElementById('resetBtn');
  resetBtn && resetBtn.addEventListener('click', function(){ location.reload(); });

  const projectChoice = document.getElementById('project_choice');
  projectChoice && projectChoice.addEventListener('change', function(){
    const val = this.value;
    if (!val) return;
    location.href = "{% url 'projects:edit' 0 %}".replace('/0/','/' + val + '/');
  });

  // keep existing hidden watcher behavior (PDL/PM)
  function attachHiddenWatcher(hiddenId, nameFieldId, pickerId){
    const hidden = document.getElementById(hiddenId);
    const nameField = document.getElementById(nameFieldId);
    const picker = document.getElementById(pickerId);
    if (!hidden || !nameField || !picker) return;
    hidden.addEventListener('change', function(){
      const v = picker.value || '';
      const m = v.match(/^(.+?)\s*\(/);
      if (m) nameField.value = m[1].trim();
      else nameField.value = v || hidden.value || '';
    });
    if (picker.value && !nameField.value) {
      const m = picker.value.match(/^(.+?)\s*\(/);
      if (m) nameField.value = m[1].trim();
    }
  }
  attachHiddenWatcher('pdl_user_id','pdl_name','pdl_picker');
  attachHiddenWatcher('pm_user_id','pm_name','pm_picker');
})();
</script>
{% endblock %}
{% endblock %}
