{% extends "base.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<link rel="stylesheet" href="{% static 'projects/css/projects-actions.css' %}">
{% endblock %}

{% block content %}
<div class="create-wrapper" style="display:flex;gap:28px;align-items:flex-start;flex-wrap:wrap;">

  <!-- LEFT: Edit Project FORM -->
  <div class="create-panel" style="flex:0 0 720px;min-width:320px;">
    <div class="panel" style="padding:26px;">
      <h2 style="margin:0 0 14px 0">Edit Project</h2>

      {% if messages %}
        {% for m in messages %}
          <div role="alert" style="margin-bottom:12px; font-weight:700; color: {% if m.tags == 'error' %}#b91c1c{% else %}#064e3b{% endif %};">
            {{ m }}
          </div>
        {% endfor %}
      {% endif %}

      <form method="post" class="form-grid" id="editProjectForm" style="margin-top:6px;">
        {% csrf_token %}

        <label>
          <div style="font-weight:700;margin-bottom:8px">Select Project (you are the creator)</div>
          <select name="project_choice" id="project_choice" class="form-input" required>
            <option value="">-- Select project --</option>
            {% for p in editable_projects %}
              <option value="{{ p.id }}" {% if selected_project and selected_project.id == p.id %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          <div style="font-weight:700;margin-bottom:8px">OEM Name</div>
          <input type="text" name="oem_name" id="oem_name" class="form-input" value="{{ selected_project.oem_name|default_if_none:'' }}">
        </label>

        <div style="display:flex;gap:14px;">
          <label style="flex:1">
            <div style="font-weight:700;margin-bottom:8px">Start Date</div>
            <input type="date" name="start_date" id="start_date" class="form-input" value="{{ selected_project.start_date|default_if_none:'' }}">
          </label>
          <label style="flex:1">
            <div style="font-weight:700;margin-bottom:8px">End Date</div>
            <input type="date" name="end_date" id="end_date" class="form-input" value="{{ selected_project.end_date|default_if_none:'' }}">
          </label>
        </div>

        <label>
          <div style="font-weight:700;margin-bottom:8px">Program Development Lead (PDL)</div>
          <!-- visible input (search+display) -->
          <input id="pdl_picker" name="pdl_display" type="text" class="form-input" placeholder="Type at least 3 chars to search LDAP..." autocomplete="off"
                 value="{% if selected_project.pdl_name %}{{ selected_project.pdl_name }} ({{ selected_project.pdl_user_id|default_if_none:'' }}){% endif %}" />
          <!-- hidden field that stores email (or canonical identifier) -->
          <input id="pdl_user_id" name="pdl_user_id" type="hidden" value="{% if selected_project.pdl_user_id %}{{ selected_project.pdl_user_id }}{% endif %}" />
          <!-- readonly explicit pdl name -->
          <input id="pdl_name" type="text" readonly class="form-input" style="margin-top:8px;background:#f8fafc;" value="{{ selected_project.pdl_name|default_if_none:'' }}" />
          <div id="pdl_suggestions" class="autocomplete-list" aria-hidden="true"></div>
        </label>

        <label>
          <div style="font-weight:700;margin-bottom:8px">Project Manager (PM)</div>
          <input id="pm_picker" name="pm_display" type="text" class="form-input" placeholder="Type at least 3 chars to search LDAP..." autocomplete="off"
                 value="{% if selected_project.pm_name %}{{ selected_project.pm_name }} ({{ selected_project.pm_user_id|default_if_none:'' }}){% endif %}" />
          <input id="pm_user_id" name="pm_user_id" type="hidden" value="{% if selected_project.pm_user_id %}{{ selected_project.pm_user_id }}{% endif %}" />
          <input id="pm_name" type="text" readonly class="form-input" style="margin-top:8px;background:#f8fafc;" value="{{ selected_project.pm_name|default_if_none:'' }}" />
          <div id="pm_suggestions" class="autocomplete-list" aria-hidden="true"></div>
        </label>

        <label>
          <div style="font-weight:700;margin-bottom:8px">Description</div>
          <textarea name="description" id="description" rows="4" class="form-input" placeholder="Short description">{{ selected_project.description|default_if_none:'' }}</textarea>
        </label>

        <div class="form-actions" style="margin-top:6px;">
          <button type="button" id="resetBtn" class="btn secondary">Reset</button>
          <button type="submit" class="btn primary">Edit Project</button>
        </div>
      </form>
    </div>

    <!-- DETAILS: show full project data below -->
    <div class="panel" style="padding:18px; margin-top:18px;">
      <h2 style="margin:0 0 12px 0">Project Details</h2>
      {% if selected_project %}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div><strong>Name</strong><div>{{ selected_project.name }}</div></div>
          <div><strong>OEM</strong><div>{{ selected_project.oem_name|default_if_none:"‚Äî" }}</div></div>
          <div><strong>PDL</strong><div>{{ selected_project.pdl_name|default_if_none:"‚Äî" }} {% if selected_project.pdl_user_id %}&lt;id: {{ selected_project.pdl_user_id }}&gt;{% endif %}</div></div>
          <div><strong>PM</strong><div>{{ selected_project.pm_name|default_if_none:"‚Äî" }} {% if selected_project.pm_user_id %}&lt;id: {{ selected_project.pm_user_id }}&gt;{% endif %}</div></div>
          <div><strong>Start</strong><div>{{ selected_project.start_date|default_if_none:"‚Äî" }}</div></div>
          <div><strong>End</strong><div>{{ selected_project.end_date|default_if_none:"‚Äî" }}</div></div>
          <div style="grid-column: 1 / -1;"><strong>Description</strong><div style="margin-top:6px">{{ selected_project.description|default_if_none:"‚Äî" }}</div></div>
        </div>
      {% else %}
        <div class="muted">No project selected or no editable projects available where you are the creator.</div>
      {% endif %}
    </div>
  </div>

  <!-- RIGHT: Action Panel (flat button list) -->
  <div class="actions-column" style="flex:1;min-width:360px;">
    <div class="actions-panel" id="actionsPanel">
      <h3 style="margin:0 0 16px 0">Project Actions</h3>
      <div class="action-buttons">
        <a href="{% url 'projects:list' %}" class="btn-light">üìë View Projects</a>
        <a href="{% url 'projects:create' %}" class="btn-light">‚ûï Create Project</a>
        <a href="#" class="btn-light" onclick="window.scrollTo({top:0,behavior:'smooth'});return false;">‚úèÔ∏è Edit Project</a>
        <a href="#" class="btn-light danger">üóëÔ∏è Delete Project</a>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script src="{% static 'projects/js/projects-actions.js' %}"></script>

<script>
  // Reset button behaviour: reset the visible fields to last loaded selected_project values
  (function(){
    const resetBtn = document.getElementById('resetBtn');
    resetBtn && resetBtn.addEventListener('click', function(){
      // simple page reload is the easiest reliable reset (preserves server state)
      location.reload();
    });

    // When project selection changes, reload the page to show the selected project's values
    const projectChoice = document.getElementById('project_choice');
    projectChoice && projectChoice.addEventListener('change', function(){
      const val = this.value;
      if (!val) return;
      // redirect to edit/<project_id>/ (this view will load selected project)
      location.href = "{% url 'projects:edit' 0 %}".replace('/0/','/' + val + '/');
    });

    // We'll wire fill-ins after projects-actions.js initializes its autocomplete.
    // That file wires pdl_picker and others; we added pm wiring as well in its updated source.
    // Listen for autocomplete selections by observing hidden fields and copying CN to readonly fields.
    function attachHiddenWatcher(hiddenId, nameFieldId, pickerId){
      const hidden = document.getElementById(hiddenId);
      const nameField = document.getElementById(nameFieldId);
      const picker = document.getElementById(pickerId);
      if (!hidden || !nameField || !picker) return;
      // when hidden changes (set by autocomplete), update the readonly name input to whatever the visible picker shows (strip email)
      hidden.addEventListener('change', function(){
        // visible picker value usually contains "CN (email)" - extract CN portion
        const v = picker.value || '';
        const m = v.match(/^(.+?)\s*\(/);
        if (m) {
          nameField.value = m[1].trim();
        } else {
          // fallback to hidden if visible not set
          nameField.value = v || hidden.value || '';
        }
      });
      // also on page load ensure nameField is set if values exist
      if (picker.value && !nameField.value) {
        const m = picker.value.match(/^(.+?)\s*\(/);
        if (m) nameField.value = m[1].trim();
      }
    }

    // Attach watchers for PDL and PM
    attachHiddenWatcher('pdl_user_id', 'pdl_name', 'pdl_picker');
    attachHiddenWatcher('pm_user_id', 'pm_name', 'pm_picker');
  })();
</script>
{% endblock %}
{% endblock %}
