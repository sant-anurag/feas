{% extends "base.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<link rel="stylesheet" href="{% static 'projects/css/projects-actions.css' %}">
<style>
/* reuse mapping styles */
.mapping-card { margin-top: 20px; border-radius: 12px; background: linear-gradient(180deg,#fff,#fbfdff); border: 1px solid rgba(15,23,42,0.04); box-shadow: 0 8px 24px rgba(16,24,40,0.06); padding: 18px; }
.mapping-grid { display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap; }
.mapping-left { min-width:260px; width:320px; }
.mapping-right {
  flex: 1 1 0;
  min-width: 0;
}
.project-list { list-style:none; padding:8px; margin:0; border-radius:8px; border:1px solid rgba(15,23,42,0.04); max-height:320px; overflow:auto; }
.project-item { padding:12px; border-radius:8px; background:linear-gradient(180deg,#fff,#fff); margin-bottom:8px; display:flex; gap:10px; align-items:center; box-shadow: 0 1px 0 rgba(15,23,42,0.02); }
.coe-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto; /* let columns size naturally */
}

.coe-table thead th {
  padding: 10px 12px;
  text-align: left;
  font-weight: 700;
  border-bottom: 1px solid rgba(15,23,42,0.06);
}

.coe-table tbody {
  display: table-row-group; /* restore normal flow */
  max-height: unset;        /* no artificial limit */
  overflow: visible;
}

.coe-table td {
  padding: 10px 12px;
  vertical-align: middle;
  word-break: break-word;   /* long names wrap nicely */
}}
/* filter/search & select all */
.coe-filter { width:260px; padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); }
.select-all-label { display:inline-flex; align-items:center; gap:8px; color:#374151; font-size:14px; margin-right:12px; }
.status-toast { position:fixed; right:28px; top:96px; z-index:99999; min-width:280px; padding:12px 16px; border-radius:10px; font-weight:700; box-shadow:0 8px 24px rgba(15,23,42,0.12); }
.mapping-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
.mapping-title { font-weight:700; font-size:16px; margin-bottom:6px; }
</style>
{% endblock %}

{% block content %}
<div style="display:flex; gap:28px; align-items:flex-start; flex-wrap:wrap;">
  <!-- Left: Edit Project form -->
  <div style="flex:0 0 640px; min-width:320px;">
    <div class="panel" style="padding:26px;">
      <h2>Edit Project</h2>

      <form method="post" id="editProjectForm">
        {% csrf_token %}
        <label>
          <div class="label-title">Project Name</div>
          <input type="text" name="name" id="proj_name_input" required class="form-input" value="{{ project.name }}" />
        </label>

        <label>
          <div class="label-title">Description</div>
          <textarea name="description" id="proj_desc_input" rows="4" class="form-input">{{ project.description }}</textarea>
        </label>

        <div style="display:flex; gap:12px;">
          <label style="flex:1">
            <div class="label-title">Start Date</div>
            <input type="date" name="start_date" id="proj_start_date" class="form-input" value="{{ project.start_date|date:'Y-m-d' }}" />
          </label>
          <label style="flex:1">
            <div class="label-title">End Date</div>
            <input type="date" name="end_date" id="proj_end_date" class="form-input" value="{{ project.end_date|date:'Y-m-d' }}" />
          </label>
        </div>

        <label>
          <div class="label-title">Program Development Lead (PDL)</div>
          <input id="pdl_picker" name="pdl_display" type="text" class="form-input" autocomplete="off" />
          <input id="pdl_username" name="pdl_username" type="hidden" value="{{ project.pdl_user_id|default:'' }}" />
        </label>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
          <a href="{% url 'projects:list' %}" class="btn secondary">Cancel</a>
          <button type="submit" class="btn primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Right: Actions -->
  <div style="flex:1; min-width:360px;">
    <div class="actions-panel" style="padding:18px;border-radius:10px;background:#fff;border:1px solid rgba(15,23,42,0.04);box-shadow:0 6px 18px rgba(16,24,40,0.03)">
      <h3>Project Actions</h3>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
        <a href="#" class="btn-light" data-open="coeCreateModal">‚ûï Create COE</a>
        <a href="#" class="btn-light" data-open="coeListModal">‚úèÔ∏è Edit COE</a>
        <a href="#" class="btn-light" data-open="coeLeaderModal">üë§ Assign/Edit Leader</a>
        <a href="#" class="btn-light" data-open="domainCreateModal">üìÇ Create Domain</a>
        <a href="#" class="btn-light" data-open="domainEditModal">‚úèÔ∏è Edit Domain</a>
        <a href="{% url 'projects:list' %}" class="btn-light">üìë View Projects</a>
        <a href="#" class="btn-light danger" data-open="projectDeleteModal">üóëÔ∏è Delete Project</a>
      </div>
    </div>
  </div>
</div>

<!-- Mapping panel below the edit form -->
<div class="mapping-card" id="mappingCard">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <div class="mapping-title">Assign COEs to this Project</div>
    </div>

    <div style="display:flex; align-items:center; gap:12px;">
      <label class="select-all-label"><input type="checkbox" id="selectAllCoes"> Select all</label>
      <input id="coeFilterInput" class="coe-filter" placeholder="Filter COEs by name..." />
    </div>
  </div>

  <div class="mapping-grid" style="margin-top:12px;">
    <div class="mapping-left">
      <div style="font-weight:600; margin-bottom:8px;">Project</div>
      <ul class="project-list" id="projectList">
        <li class="project-item">
          <label style="display:flex; gap:10px; align-items:center; width:100%;">
            <input type="radio" name="project_choice" value="{{ project.id }}" checked>
            <div>
              <div style="font-weight:700;">{{ project.name }}</div>
              <div class="meta">Edit mapping for this project</div>
            </div>
          </label>
        </li>
      </ul>
    </div>

    <div class="mapping-right">
      <div style="font-weight:600; margin-bottom:8px;">COEs</div>

      <table class="coe-table">
        <thead>
          <tr><th style="width:48px"></th><th>COE Name</th></tr>
        </thead>
        <tbody id="coeTbody">
          {% if coes %}
            {% for coe in coes %}
              <tr data-coe-name="{{ coe.name|lower }}">
                <td style="width:48px; padding:8px 12px;"><input type="checkbox" class="coe-checkbox" value="{{ coe.id }}" {% if coe.id in assigned_coe_ids %}checked{% endif %}></td>
                <td style="padding:8px 12px;">{{ coe.name }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="2" class="muted" style="padding:12px">No COEs available.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="mapping-controls">
    <button type="button" class="btn secondary" id="mappingClearBtn">Clear</button>
    <button type="button" class="btn primary" id="mappingSaveBtn">Save</button>
  </div>
</div>

{% block extra_js %}
<script src="{% static 'projects/js/projects-actions.js' %}"></script>
<script>
/* mapping logic for edit page: reuse same JS names and behavior as create page */
(function(){
  // identical inline mapping handling used in create_project.html; you can keep both for robustness
  // This script uses the same DOM IDs as create page mapping panel
  // If projects-actions.js attaches window.refreshCoesList / refreshProjectsList, they will be used after saving.
})();
</script>
{% endblock %}
{% endblock %}
