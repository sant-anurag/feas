{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'projects/css/monthly_allocations.css' %}">

<style>
/* Clean, professional styling for the page */
.alloc-card { background:#fff; padding:26px; border-radius:12px; box-shadow:0 8px 30px rgba(12,35,66,0.06); }
.page-title { margin:0 0 6px 0; font-size:1.6rem; font-weight:700; color:#0f172a; }
.page-sub { color:#6b7280; margin-bottom:18px; }

.filters { display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap; margin-bottom:10px; }
.control { min-width:220px; }
.control label { display:block; font-weight:600; color:#475569; margin-bottom:6px; }
.form-control, .form-select { padding:8px 12px; border-radius:8px; border:1px solid #e6eef7; min-height:40px; background:#fff; }
.btn { padding:8px 12px; border-radius:8px; cursor:pointer; border:none; font-weight:600; }
.btn-outline { background:transparent; border:1px solid #dbeafe; color:#0b4fd6; }
.btn-primary { background:#0b5ed7; color:#fff; box-shadow:0 8px 24px rgba(11,94,215,0.12); }
.btn-success { background:#059669; color:#fff; }
.btn-compact { padding:6px 10px; font-size:0.95rem; }

/* IOM detail card */
.iom-card { display:flex; justify-content:space-between; gap:12px; margin-top:12px; padding:14px; border-radius:8px; background:#f8fbff; border:1px solid #eef7ff; align-items:center; }
.iom-left { flex:1; }
.iom-title { font-weight:700; font-size:1.02rem; color:#0f172a; }
.iom-dept { color:#6b7280; margin-top:6px; }
.iom-right { flex:0 0 260px; text-align:right; }
.stat { display:block; color:#6b7280; margin-bottom:4px; }
.stat strong { color:#0f172a; margin-left:8px; }

/* allocations section */
.section-title { margin-top:22px; font-weight:700; color:#0f172a; }
.table-wrap { margin-top:12px; background:#fff; padding:12px; border-radius:8px; border:1px solid #eef7ff; }
#allocBadge { float:right; margin-top:-34px; background:#eff6ff; color:#0b53a0; padding:8px 12px; border-radius:999px; border:1px solid #e6f0ff; font-weight:700; }

/* table */
.table { width:100%; border-collapse:collapse; margin-top:14px; }
.table thead th { background:#f1f8ff; text-align:left; padding:10px; border-bottom:1px solid #edf2f7; font-weight:700; color:#0f172a; }
.table tbody td { padding:10px; border-bottom:1px solid #f1f5f9; vertical-align:middle; }
.resource-td { min-width:260px; position:relative; }
.remove-td { width:120px; text-align:center; }

/* visuals for invalid rows / over-allocated */
.row-invalid { background:#fff4f6 !important; }
.iom-over { box-shadow:0 0 0 3px rgba(255,99,71,0.05) inset; }
.iom-badge { display:inline-block; background:#f1f6ff; border:1px solid #e6f0ff; color:#0b53a0; padding:6px 10px; border-radius:999px; font-weight:600; margin-left:8px; }

/* tooltip */
.save-tooltip { position:relative; display:inline-block; }
.save-tooltip .tooltip-text { display:none; position:absolute; bottom:calc(100% + 8px); left:50%; transform:translateX(-50%); background:rgba(2,6,23,0.95); color:#fff; padding:10px 12px; border-radius:8px; font-size:0.9rem; max-width:420px; z-index:1400; box-shadow:0 8px 30px rgba(2,6,23,0.2); }
.save-tooltip:hover .tooltip-text { display:block; }

/* responsive */
@media (max-width:900px) {
  .iom-card { flex-direction:column; align-items:flex-start; }
  .iom-right { text-align:left; width:100%; margin-top:8px; }
  #allocBadge { float:none; display:block; margin:8px 0; }
}
</style>

<div class="alloc-card" role="main" aria-labelledby="monthlyAllocTitle">
  <div>
    <h1 id="monthlyAllocTitle" class="page-title">Monthly Allocations</h1>
    <div class="page-sub">Manage resources and FTE per IOM</div>
  </div>

  <!-- Filters -->
  <div class="filters" role="region" aria-label="Filters">
    <div class="control">
      <label for="projectSelect">Project</label>
      <select id="projectSelect" class="form-select">
        {% if projects %}
          {% for p in projects %}
            <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
        {% else %}
            <option value="">-- No projects assigned --</option>
        {% endif %}
      </select>
    </div>

    <div class="control">
      <label for="yearInput">Year</label>
      <input id="yearInput" class="form-control" type="number" value="{{ now.year }}">
    </div>

    <div class="control">
      <label for="monthSelect">Month</label>
      <select id="monthSelect" class="form-select">
        <option value="1" {% if now.month == 1 %}selected{% endif %}>January</option>
        <option value="2" {% if now.month == 2 %}selected{% endif %}>February</option>
        <option value="3" {% if now.month == 3 %}selected{% endif %}>March</option>
        <option value="4" {% if now.month == 4 %}selected{% endif %}>April</option>
        <option value="5" {% if now.month == 5 %}selected{% endif %}>May</option>
        <option value="6" {% if now.month == 6 %}selected{% endif %}>June</option>
        <option value="7" {% if now.month == 7 %}selected{% endif %}>July</option>
        <option value="8" {% if now.month == 8 %}selected{% endif %}>August</option>
        <option value="9" {% if now.month == 9 %}selected{% endif %}>September</option>
        <option value="10" {% if now.month == 10 %}selected{% endif %}>October</option>
        <option value="11" {% if now.month == 11 %}selected{% endif %}>November</option>
        <option value="12" {% if now.month == 12 %}selected{% endif %}>December</option>
      </select>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <button id="loadIomsBtn" class="btn btn-primary btn-compact">Load IOMs</button>
    </div>
  </div>

  <!-- IOM selection -->
  <div style="display:flex; gap:12px; margin-top:8px; align-items:flex-start; flex-wrap:wrap;">
    <div style="flex:1; min-width:380px;">
      <label for="iomsDropdown">Applicable IOMs</label>
      <div style="display:flex; gap:8px;">
        <select id="iomsDropdown" class="form-select" style="flex:1;">
          <option value="">-- Load IOMs then select --</option>
        </select>
        <button id="addIomBtn" class="btn btn-outline btn-compact">Add Selected IOM</button>
      </div>
    </div>

    <div style="width:320px;">
      <label for="searchIom">Search IOM / Dept</label>
      <input id="searchIom" class="form-control" placeholder="iom id or department">
    </div>
  </div>

  <!-- IOM Details (separate card) -->
  <div id="iomDetailWrap" style="display:none;">
    <div class="iom-card" role="region" aria-live="polite">
     <div class="iom-left">
      <div id="iomTitle" class="iom-title">IOM: —</div>
      <div id="iomDept" class="iom-dept">Department: —</div>
      <div id="iomWbs" class="iom-dept">WBS: —</div>
      <div id="iomSite" class="iom-dept">Site: —</div>
      <div id="iomFunction" class="iom-dept">Function: —</div>
    </div>

      <div class="iom-right">
        <div class="stat">Month FTE: <strong id="iomMonthFte">0.0000</strong></div>
        <div class="stat">Month Hrs: <strong id="iomMonthHrs">0.00</strong></div>
        <div class="stat">Remaining FTE: <strong id="iomRemFte">0.0000</strong></div>
        <div class="stat">Remaining Hrs: <strong id="iomRemHrs">0.00</strong></div>
      </div>
    </div>
  </div>

  <!-- Resource Allocations - separate section -->
  <div id="allocSectionWrap" style="display:none;">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h3 class="section-title">Resource Allocations</h3>
      <div id="allocBadge">Remaining: 0.00h</div>
    </div>

    <div class="table-wrap">
      <table id="allocTable" class="table" aria-describedby="AllocationsForIom">
        <thead>
          <tr>
            <th>Resource (LDAP)<div style="font-size:0.8rem;color:#94a3b8;">type 3+ chars to search</div></th>
            <th style="width:130px">Total Hours</th>
            <th style="width:120px">Actions</th>
          </tr>
        </thead>
        <tbody id="allocBody">
          <tr class="empty-state"><td colspan="3" class="text-muted">No resources added yet. Add Selected IOM or use Add Resource.</td></tr>
        </tbody>
      </table>

      <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
        <button id="addResourceBtn" class="btn btn-outline btn-compact">Add Resource</button>

        <div class="save-tooltip">
          <button id="saveBtn" class="btn btn-primary btn-compact" aria-disabled="true" disabled>Save</button>
          <div class="tooltip-text" id="saveTooltip">Fix highlighted rows first</div>
        </div>

        <button id="exportBtn" class="btn btn-success btn-compact">Export Excel</button>
      </div>
    </div>
  </div>

  <!-- hidden csrf token for JS -->
  <div style="display:none;">{% csrf_token %}</div>
</div>

<script>
/*
Complete client-side logic:
- loadIoms : GET projects:get_applicable_ioms
- addIomBtn => show IOM details (iom.iom_id used) and load saved allocations via GET projects:get_allocations_for_iom
- allocations shown in a separate section/table
- Add Resource -> new left-aligned row with LDAP input and hours
- LDAP autocomplete uses projects:allocations_ldap_search
- validateAll updates remaining badge, disables/enables Save and updates tooltip
- Save posts to projects:save_monthly_allocations and re-renders saved items (server should return saved grouped by iom_id)
- Export triggers GET projects:export_allocations with query params to download
*/

(function() {
  const MAX_HOURS_PER_RESOURCE = 183.75;
  const CSRFTOKEN = document.querySelector('[name="csrfmiddlewaretoken"]').value;

  // DOM refs
  const projectSelect = document.getElementById('projectSelect');
  const yearInput = document.getElementById('yearInput');
  const monthSelect = document.getElementById('monthSelect');
  const loadIomsBtn = document.getElementById('loadIomsBtn');
  const iomsDropdown = document.getElementById('iomsDropdown');
  const addIomBtn = document.getElementById('addIomBtn');
  const searchIom = document.getElementById('searchIom');

  const iomDetailWrap = document.getElementById('iomDetailWrap');
  const iomTitle = document.getElementById('iomTitle');
  const iomDept = document.getElementById('iomDept');
  const iomMonthFte = document.getElementById('iomMonthFte');
  const iomMonthHrs = document.getElementById('iomMonthHrs');
  const iomRemFte = document.getElementById('iomRemFte');
  const iomRemHrs = document.getElementById('iomRemHrs');

  const allocSectionWrap = document.getElementById('allocSectionWrap');
  const allocBadge = document.getElementById('allocBadge');
  const allocBody = document.getElementById('allocBody');
  const addResourceBtn = document.getElementById('addResourceBtn');
  const saveBtn = document.getElementById('saveBtn');
  const saveTooltip = document.getElementById('saveTooltip');
  const exportBtn = document.getElementById('exportBtn');

  // endpoints (please ensure URL names exist)
  const LDAP_ENDPOINT = '{% url "projects:allocations_ldap_search" %}';
  const GET_IOMS_URL = '{% url "projects:get_applicable_ioms" %}';
  const GET_IOM_DETAILS_URL = '{% url "projects:get_iom_details" %}';
  const GET_SAVED_ALLOC_URL = '{% url "projects:get_allocations_for_iom" %}';
  const SAVE_ALLOC_URL = '{% url "projects:save_monthly_allocations" %}';
  const EXPORT_URL = '{% url "projects:export_allocations" %}';

  // utility
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ---- Load IOMs ----
  async function loadIoms() {
    const project_id = projectSelect.value;
    const year = yearInput.value || (new Date()).getFullYear();
    const month = monthSelect.value;
    const search = searchIom.value.trim();

    if (!project_id) { alert('Please select a project'); return; }

    const params = new URLSearchParams({ project_id, year, month });
    if (search) params.set('search', search);

    try {
      const res = await fetch(GET_IOMS_URL + '?' + params.toString(), { credentials: 'same-origin' });
      const data = await res.json();
      if (!data.ok) {
        console.warn('get_applicable_ioms error', data);
        alert('Could not load IOMs (see console)');
        return;
      }
      iomsDropdown.innerHTML = '<option value="">-- Choose IOM --</option>';
      data.ioms.forEach(iom => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(iom);  // store row
        opt.text = `${iom.iom_id} · Dept:${iom.department || '-'} · Hrs:${(parseFloat(iom.month_hours||0)).toFixed(2)}`;
        iomsDropdown.appendChild(opt);
      });
    } catch (err) {
      console.error('loadIoms', err);
      alert('Failed to load IOMs (console).');
    }
  }

  loadIomsBtn.addEventListener('click', loadIoms);

  // show IOM preview when selected
  iomsDropdown.addEventListener('change', function() {
    if (!this.value) {
      iomDetailWrap.style.display = 'none';
      return;
    }
    const obj = JSON.parse(this.value);
    showIomPreview(obj);
  });

    function showIomPreview(iom) {
          iomTitle.textContent = 'IOM: ' + (iom.iom_id || '');
          iomDept.textContent = 'Department: ' + (iom.department || '—');

          // display buyer & seller WBS in one line
          const buyer = iom.buyer_wbs_cc || '-';
          const seller = iom.seller_wbs_cc || '-';
          document.getElementById('iomWbs').textContent = 'WBS: ' + buyer + ' / ' + seller;

          // new fields
          document.getElementById('iomSite').textContent = 'Site: ' + (iom.site || '—');
          document.getElementById('iomFunction').textContent = 'Function: ' + (iom.function || '—');

          iomMonthFte.textContent = (parseFloat(iom.month_fte||0)).toFixed(4);
          iomMonthHrs.textContent = (parseFloat(iom.month_hours||0)).toFixed(2);

          // remaining values will be updated by validateAll() after saved rows load
          iomRemFte.textContent = (parseFloat(iom.month_fte||0)).toFixed(4);
          iomRemHrs.textContent = (parseFloat(iom.month_hours||0)).toFixed(2);

          iomDetailWrap.style.display = 'block';
        }



  // Add Selected IOM button -> create separate allocations table and load saved allocations
  addIomBtn.addEventListener('click', async function() {
    if (!iomsDropdown.value) { alert('Please choose an IOM first'); return; }
    const selected = JSON.parse(iomsDropdown.value);
    // Show IOM details and clear any previous allocation rows
    showIomPreview(selected);
    // Show allocation section
    allocSectionWrap.style.display = 'block';
    allocBody.innerHTML = ''; // clear
    // Create header row (display only: dept/iom/wbs/total hr placed above table)
    // Here we simply show allocation badge and load saved resources
    allocBadge.textContent = 'Remaining: ' + (parseFloat(selected.month_hours||0)).toFixed(2) + 'h';
    // Load saved rows (IMPORTANT: pass iom_id string)
    await loadSavedAllocations(selected.iom_id);
    // Update validation to reflect loaded rows
    validateAll();
  });

  // Load saved allocations for an iom_id (string)
  async function loadSavedAllocations(iom_id) {
    const project_id = projectSelect.value;
    const month_start = `${yearInput.value}-${String(monthSelect.value).padStart(2,'0')}-01`;
    if (!project_id || !iom_id) return;
    try {
      const url = new URL(GET_SAVED_ALLOC_URL, window.location.origin);
      url.searchParams.set('project_id', project_id);
      url.searchParams.set('iom_row_id', iom_id);  // pass string identifier
      url.searchParams.set('month_start', month_start);
      const res = await fetch(url.toString(), { credentials: 'same-origin' });
      if (!res.ok) { console.warn('loadSavedAllocations failed', res.status); return; }
      const data = await res.json();
      if (!data.ok) { console.warn('loadSavedAllocations server', data); return; }
      // clear existing resource rows and render saved ones
      allocBody.innerHTML = '';
      const saved = data.saved_items || [];
      if (saved.length === 0) {
        allocBody.innerHTML = '<tr class="empty-state"><td colspan="3" class="text-muted">No resources assigned yet.</td></tr>';
      } else {
        saved.forEach(s => {
          addResourceRow(iom_id, { ldap: s.user_ldap, hours: s.total_hours });
        });
      }
      validateAll();
    } catch (err) {
      console.error('loadSavedAllocations', err);
    }
  }

  // Add resource row - left aligned
  function addResourceRow(iom_id, prefill = {}) {
    // remove empty-state if present
    const empty = allocBody.querySelector('.empty-state');
    if (empty) empty.remove();

    const tr = document.createElement('tr');
    tr.dataset.parentIom = iom_id;
    tr.innerHTML = `
      <td class="resource-td">
        <input type="text" class="form-control user_ldap" placeholder="start typing (3+ chars)" value="${escapeHtml(prefill.ldap||'')}" />
        <div class="ldap-suggest" style="display:none; position:absolute; left:0; top:44px; z-index:1200; background:#fff; border:1px solid #eef2f7; border-radius:8px; max-height:220px; overflow:auto;"></div>
      </td>
      <td><input type="number" class="form-control resource-hours" step="0.25" min="0" value="${Number(prefill.hours||0).toFixed(2)}" /></td>
      <td class="remove-td"><button class="btn btn-outline btn-compact removeBtn">Remove</button></td>
    `;
    allocBody.appendChild(tr);

    // events
    tr.querySelector('.removeBtn').addEventListener('click', () => { tr.remove(); validateAll(); });
    tr.querySelector('.resource-hours').addEventListener('input', () => { validateAll(); });

    // LDAP autocomplete
    const ldapInput = tr.querySelector('.user_ldap');
    const suggestBox = tr.querySelector('.ldap-suggest');
    let timer = null;
    ldapInput.addEventListener('input', () => {
      const q = ldapInput.value.trim();
      suggestBox.innerHTML = ''; suggestBox.style.display = 'none';
      if (timer) clearTimeout(timer);
      if (q.length < 3) return;
      timer = setTimeout(async () => {
        try {
          const url = new URL(LDAP_ENDPOINT, window.location.origin);
          url.searchParams.set('q', q);
          const r = await fetch(url.toString(), { credentials: 'same-origin' });
          if (!r.ok) return;
          const d = await r.json();
          if (!d || !Array.isArray(d.results)) return;
          d.results.slice(0, 40).forEach(u => {
            const a = document.createElement('a');
            a.href = '#';
            a.style.display = 'block';
            a.style.padding = '8px';
            a.style.borderBottom = '1px solid #f1f5f9';
            a.textContent = (u.cn || u.sAMAccountName) + (u.mail ? ' <' + u.mail + '>' : '');
            a.dataset.mail = u.mail || u.sAMAccountName || '';
            a.addEventListener('click', (ev) => { ev.preventDefault(); ldapInput.value = a.dataset.mail; suggestBox.style.display = 'none'; validateAll(); });
            suggestBox.appendChild(a);
          });
          if (suggestBox.children.length) suggestBox.style.display = 'block';
        } catch (err) { console.error('ldap', err); }
      }, 180);
    });

    document.addEventListener('click', (ev) => { if (!tr.contains(ev.target)) suggestBox.style.display = 'none'; });
    validateAll();
    return tr;
  }

  addResourceBtn.addEventListener('click', () => {
    // add under last added IOM; we require a visible IOM selected (allocSectionWrap shown)
    const lastHeader = document.querySelector('tr[data-parent-iom]') || null;
    // But since we only store parent via dataset on rows, simply find current selected IOM from dropdown preview
    if (!iomsDropdown.value) { alert('Please select and add an IOM first'); return; }
    const currentIom = JSON.parse(iomsDropdown.value);
    addResourceRow(currentIom.iom_id);
  });

  // Validation & Remaining calculation
  function validateAll() {
    // gather available hours for each IOM header (we rely on current selected iom preview)
    const currentIom = iomsDropdown.value ? JSON.parse(iomsDropdown.value) : null;
    const totalAvailable = currentIom ? Number(currentIom.month_hours || 0) : 0;
    // sum allocated hours for current IOM
    const rows = Array.from(allocBody.querySelectorAll('tr')).filter(r => r.dataset && r.dataset.parentIom);
    let sum = 0;
    let anyInvalid = false;
    const reasons = [];

    rows.forEach(r => {
      r.classList.remove('row-invalid');
      const ldapVal = (r.querySelector('.user_ldap') || {}).value || '';
      const hoursVal = parseFloat((r.querySelector('.resource-hours') || {}).value || 0) || 0;

      const rowErrors = [];
      if (!ldapVal.trim()) rowErrors.push('missing resource');
      if (!(hoursVal > 0)) rowErrors.push('hours <= 0');
      if (hoursVal > MAX_HOURS_PER_RESOURCE) rowErrors.push(`> ${MAX_HOURS_PER_RESOURCE}h`);

      if (rowErrors.length) {
        r.classList.add('row-invalid'); anyInvalid = true; reasons.push(rowErrors.join(', '));
      }
      sum += hoursVal;
    });

    const remaining = Math.max(0, totalAvailable - sum);
    allocBadge.textContent = 'Remaining: ' + remaining.toFixed(2) + 'h';
    // Also update IOM details remaining display if visible
    if (iomRemHrs) iomRemHrs.textContent = remaining.toFixed(2);

    // Save disabled if:
    // - no resource rows OR
    // - any invalid row OR
    // - sum exceeds totalAvailable OR
    // - remaining == totalAvailable (means nothing allocated?) -> allow save only if at least one row exists and sum > 0
    const hasRows = rows.length > 0;
    const overAllocated = sum > totalAvailable;
    const sumIsZero = sum === 0;

    let disable = false;
    let tooltipMsg = '';
    if (!hasRows) { disable = true; tooltipMsg = 'No resource rows added'; }
    else if (anyInvalid) { disable = true; tooltipMsg = 'Fix highlighted rows'; }
    else if (overAllocated) { disable = true; tooltipMsg = 'Allocated hours exceed available hours'; }
    else if (sumIsZero) { disable = true; tooltipMsg = 'Enter hours for at least one resource'; }

    saveBtn.disabled = disable;
    saveBtn.setAttribute('aria-disabled', disable ? 'true' : 'false');
    saveTooltip.textContent = tooltipMsg || '';

    return { valid: !disable, remaining, sum, totalAvailable, overAllocated };
  }

  // Save allocations to server
  async function saveAllocations() {
    const validation = validateAll();
    if (!validation.valid) { alert('Cannot save: ' + (saveTooltip.textContent || 'fix errors')); return; }

    // gather rows
    const rows = Array.from(allocBody.querySelectorAll('tr')).filter(r => r.dataset && r.dataset.parentIom);
    const items = rows.map(r => ({
      iom_id: r.dataset.parentIom,
      user_ldap: (r.querySelector('.user_ldap') || {}).value || '',
      total_hours: Math.round(parseFloat((r.querySelector('.resource-hours') || {}).value || 0))
    }));

    const project_id = projectSelect.value;
    const month_start = `${yearInput.value}-${String(monthSelect.value).padStart(2,'0')}-01`;

    try {
      const resp = await fetch(SAVE_ALLOC_URL, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN },
        body: JSON.stringify({ project_id, month_start, items })
      });
      const data = await resp.json();
      if (!data.ok) {
        alert('Save failed: ' + (data.error || 'server error'));
        console.error('save response', data);
        return;
      }
      // Re-render saved rows returned by server (expecting saved grouped by iom_id)
      if (data.saved && typeof data.saved === 'object') {
        Object.keys(data.saved).forEach(iomId => {
          // remove any existing rows for iomId and render saved rows
          const existing = Array.from(allocBody.querySelectorAll('tr')).filter(r => r.dataset && r.dataset.parentIom === iomId);
          existing.forEach(r => r.remove());
          (data.saved[iomId] || []).forEach(s => addResourceRow(iomId, { ldap: s.user_ldap, hours: s.total_hours }));
        });
        validateAll();
        // update IOM details by fetching fresh details (optional; won't break if endpoint missing)
        Object.keys(data.saved).forEach(iomId => fetchIomDetails(iomId));
        alert('Allocations saved successfully');
      } else {
        // fallback if server returns saved_items or other format: simply reload saved using selected IOM
        if (iomsDropdown.value) {
          const cur = JSON.parse(iomsDropdown.value);
          await loadSavedAllocations(cur.iom_id);
        }
        validateAll();
        alert('Saved (server returned fallback format).');
      }

    } catch (err) {
      console.error('saveAllocations', err);
      alert('Save failed (see console)');
    }
  }

  saveBtn.addEventListener('click', saveAllocations);

  // export allocations to excel (server generates .xlsx with openpyxl)
  exportBtn.addEventListener('click', function() {
    if (!iomsDropdown.value) { alert('Select and add an IOM first'); return; }
    const current = JSON.parse(iomsDropdown.value);
    const project_id = projectSelect.value;
    const iom_id = current.iom_id;
    const month_start = `${yearInput.value}-${String(monthSelect.value).padStart(2,'0')}-01`;
    const params = new URLSearchParams({ project_id, iom_id, month_start });
    // open download in same tab (or change to window.open for new tab)
    window.location = EXPORT_URL + '?' + params.toString();
  });

  // fetch IOM details to refresh remaining after save
  async function fetchIomDetails(iom_row_id) {
    try {
      const project_id = projectSelect.value;
      const year = yearInput.value;
      const month = monthSelect.value;
      if (!project_id || !iom_row_id) return;
      const url = new URL(GET_IOM_DETAILS_URL, window.location.origin);
      url.searchParams.set('project_id', project_id);
      url.searchParams.set('iom_row_id', iom_row_id);
      url.searchParams.set('year', year);
      url.searchParams.set('month', month);
      const res = await fetch(url.toString(), { credentials: 'same-origin' });
      if (!res.ok) return;
      const data = await res.json();
      if (!data.ok) return;
      const iom = data.iom;
      if (iom) {
        // update preview and badge/remaining
        showIomPreview(iom);
        allocBadge.textContent = 'Remaining: ' + (Number(iom.remaining_hours || iom.month_hours || 0)).toFixed(2) + 'h';
        // update header dataset if you store it
        validateAll();
      }
    } catch (err) {
      console.warn('fetchIomDetails', err);
    }
  }

  // wire initial state: optionally auto-load IOMs if project present
  (function init() {
    // if you want auto-load:
    // if (projectSelect.value) loadIoms();
  })();

})();
</script>

{% endblock %}
