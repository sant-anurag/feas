{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'projects/css/monthly_allocations.css' %}">
<style>
/* IOM detail: compact single-line stats */
#iomDetailCard { display:flex; justify-content:space-between; align-items:center; gap:18px; margin-top:14px; }
#iomDetailCard .iom-left { flex:1 1 auto; }
#iomDetailCard .iom-right { flex:0 0 320px; text-align:right; font-size:0.95rem; color:var(--text); }
#iomDetailCard .iom-right .stat { display:inline-block; margin-left:12px; color:var(--muted); }

/* Make the four stats inline and slightly lighter label */
#iomDetailCard .iom-right .stat strong { color:var(--text); margin-left:6px; font-weight:600; }

/* Resource + Remove: stack Remove button under input to appear as "next line" visually */
table#allocTable td.resource-td { position:relative; min-width:220px; }
table#allocTable td.remove-td { width:120px; vertical-align:top; padding-top:6px; }
table#allocTable td.remove-td .removeBtn { display:inline-block; margin-top:8px; }
/* ensure on very narrow screens it stacks nicely */
@media (max-width:900px) {
  #iomDetailCard { flex-direction:column; align-items:flex-start; }
  #iomDetailCard .iom-right { text-align:left; width:100%; margin-top:10px; }
  table#allocTable td.remove-td { width:100%; }
  table#allocTable td.remove-td .removeBtn { width:120px; }
}

/* LDAP suggestion z-index and spacing */
.ldap-suggest { z-index:1200; max-width:420px; }

/* tiny visual tweak to the resource placeholder text */
input.user_ldap::-webkit-input-placeholder { color:#aab6c6; }
input.user_ldap::placeholder { color:#aab6c6; }
</style>

<div class="alloc-card" role="main" aria-labelledby="monthlyAllocationsTitle">
  <div class="d-flex justify-content-between">
    <div>
      <h3 id="monthlyAllocationsTitle" class="mb-0">Monthly Allocations</h3>
      <div class="sub">Manage resources and FTE per IOM</div>
    </div>
  </div>

  <!-- Top controls -->
  <div class="alloc-toprow alloc-controls" role="region" aria-label="Filters">
    <div class="control" style="min-width:260px;">
      <label for="projectSelect">Project</label>
      <select id="projectSelect" class="form-select" aria-label="Select project">
        {% for p in projects %}
          <option value="{{ p.id }}" {% if p.id == project_id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
        {% if not projects %}
          <option value="">-- No projects assigned --</option>
        {% endif %}
      </select>
    </div>

    <div class="control" style="width:130px;">
      <label for="yearInput">Year</label>
      <input id="yearInput" type="number" class="form-control" value="{{ now.year }}" aria-label="Year">
    </div>

    <div class="control" style="width:160px;">
      <label for="monthSelect">Month</label>
      <select id="monthSelect" class="form-select" aria-label="Month select">
        <option value="1" {% if now.month == 1 %}selected{% endif %}>January</option>
        <option value="2" {% if now.month == 2 %}selected{% endif %}>February</option>
        <option value="3" {% if now.month == 3 %}selected{% endif %}>March</option>
        <option value="4" {% if now.month == 4 %}selected{% endif %}>April</option>
        <option value="5" {% if now.month == 5 %}selected{% endif %}>May</option>
        <option value="6" {% if now.month == 6 %}selected{% endif %}>June</option>
        <option value="7" {% if now.month == 7 %}selected{% endif %}>July</option>
        <option value="8" {% if now.month == 8 %}selected{% endif %}>August</option>
        <option value="9" {% if now.month == 9 %}selected{% endif %}>September</option>
        <option value="10" {% if now.month == 10 %}selected{% endif %}>October</option>
        <option value="11" {% if now.month == 11 %}selected{% endif %}>November</option>
        <option value="12" {% if now.month == 12 %}selected{% endif %}>December</option>
      </select>
    </div>

    <div style="display:flex; gap:8px; align-items:flex-end;">
      <button id="loadIomsBtn" class="btn btn-primary btn-compact" aria-label="Load IOMs">Load IOMs</button>
    </div>
  </div>

  <!-- IOM select + search -->
  <div class="row mt-3 g-2" role="region" aria-label="IOM selection">
    <div class="col-md-7">
      <label class="form-label">Applicable IOMs</label>
      <div class="form-inline">
        <select id="iomsDropdown" class="form-select" aria-label="Applicable IOMs">
          <option value="">-- Load IOMs then select --</option>
        </select>
        <button id="addIomBtn" class="btn btn-outline btn-compact" aria-label="Add selected IOM">Add Selected IOM</button>
      </div>
    </div>
    <div class="col-md-5">
      <label class="form-label">Search IOM / Dept</label>
      <input id="searchIom" class="form-control" placeholder="iom id or department" aria-label="Search IOM">
    </div>
  </div>

  <!-- IOM detail card: left = title, right = inline stats -->
  <div id="iomDetailCard" class="card p-3 mt-3" role="region" aria-live="polite" style="display:none; border:1px solid #eef2f7;">
    <div class="iom-left">
      <div style="font-weight:700; font-size:1.05rem;" id="iomTitle">IOM: </div>
      <div class="small-muted" id="iomDept">—</div>
    </div>
    <div class="iom-right">
      <span class="stat">Month FTE:<strong id="iomMonthFte">0.0000</strong></span>
      <span class="stat">Month Hrs:<strong id="iomMonthHrs">0.00</strong></span>
      <span class="stat">Remaining FTE:<strong id="iomRemFte">0.0000</strong></span>
      <span class="stat">Remaining Hrs:<strong id="iomRemHrs">0.00</strong></span>
    </div>
  </div>

  <!-- Allocation table -->
  <div class="table-responsive mt-3" role="region" aria-label="Allocations table">
    <table class="table table-striped table-hover align-middle" id="allocTable">
      <thead class="table-light">
        <tr>
          <th style="min-width:160px;">Department</th>
          <th style="min-width:120px;">IOM</th>
          <th>WBS (Buyer)</th>
          <th>WBS (Seller)</th>
          <th style="width:120px;">Total Hrs</th>
          <th style="min-width:240px;">Resource (LDAP) <div class="small-muted">type 3+ chars to search</div></th>
          <th style="width:110px;">Remove</th>
        </tr>
      </thead>
      <tbody id="allocBody">
        <tr class="empty-state"><td colspan="7">No resources added yet. Load an IOM and click <strong>Add Selected IOM</strong> or use <strong>Add Resource</strong>.</td></tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex gap-2 mt-2">
    <button id="addResourceBtn" class="btn btn-outline btn-compact" aria-label="Add resource">Add Resource</button>
    <button id="saveBtn" class="btn btn-primary btn-compact" aria-label="Save allocations">Save</button>
  </div>

  <div style="display:none">{% csrf_token %}<input id="csrfTokenValue" /></div>
</div>

<script>
/*
  Updated JS:
  - LDAP fetch URL logged to console for debugging
  - addIomRow includes classes 'resource-td' and 'remove-td'
  - autocomplete attach is robust and logs network / results
*/
(function(){
  const csrftoken = (function(){
    const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : (document.cookie.split('; ').find(c=>c.startsWith('csrftoken='))||'').split('=')[1] || '';
  })();

  const projectSelect = document.getElementById('projectSelect');
  const yearInput = document.getElementById('yearInput');
  const monthSelect = document.getElementById('monthSelect');
  const loadIomsBtn = document.getElementById('loadIomsBtn');
  const iomsDropdown = document.getElementById('iomsDropdown');
  const addIomBtn = document.getElementById('addIomBtn');
  const searchIom = document.getElementById('searchIom');
  const iomDetailCard = document.getElementById('iomDetailCard');
  const iomTitle = document.getElementById('iomTitle');
  const iomDept = document.getElementById('iomDept');
  const iomMonthFte = document.getElementById('iomMonthFte');
  const iomMonthHrs = document.getElementById('iomMonthHrs');
  const iomRemFte = document.getElementById('iomRemFte');
  const iomRemHrs = document.getElementById('iomRemHrs');
  const allocBody = document.getElementById('allocBody');
  const addResourceBtn = document.getElementById('addResourceBtn');
  const saveBtn = document.getElementById('saveBtn');

  const ldapEndpoint = '{% url "projects:allocations_ldap_search" %}'; // debug-friendly

  function clearTableEmptyState() {
    const row = allocBody.querySelector('.empty-state');
    if (row) row.remove();
  }

  loadIomsBtn.addEventListener('click', async () => {
    const project_id = projectSelect.value;
    const year = yearInput.value;
    const month = monthSelect.value;
    const search = searchIom.value.trim();
    if (!project_id) { alert('Select a project'); return; }
    const params = new URLSearchParams({ project_id, year, month });
    if (search) params.set('search', search);
    try {
      const resp = await fetch('{% url "projects:get_applicable_ioms" %}?' + params.toString(), { credentials:'same-origin' });
      if (!resp.ok) throw new Error('Failed to load');
      const data = await resp.json();
      if (!data.ok) throw new Error(data.error || 'No data');
      iomsDropdown.innerHTML = '<option value="">-- Choose IOM --</option>';
      data.ioms.forEach(i => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(i);
        opt.text = `${i.iom_id} · Dept:${i.department || '-'} · Hrs:${(i.month_hours||0).toFixed(2)}`;
        iomsDropdown.appendChild(opt);
      });
    } catch (err) {
      console.error("Load IOMs error:", err);
      alert('Could not load IOMs (see console)');
    }
  });

  iomsDropdown.addEventListener('change', () => {
    if (!iomsDropdown.value) { iomDetailCard.style.display='none'; return; }
    const obj = JSON.parse(iomsDropdown.value);
    showIomPreview(obj);
  });

  addIomBtn.addEventListener('click', () => {
    if (!iomsDropdown.value) { alert('Select an IOM'); return; }
    const obj = JSON.parse(iomsDropdown.value);
    clearTableEmptyState();
    addIomRow(obj);
    fetchIomDetails(obj.id);
  });

  function showIomPreview(iom) {
    iomTitle.innerText = 'IOM: ' + iom.iom_id;
    iomDept.innerText = iom.department || '';
    iomMonthFte.innerText = (parseFloat(iom.month_fte||0)).toFixed(4);
    iomMonthHrs.innerText = (parseFloat(iom.month_hours||0)).toFixed(2);
    iomRemFte.innerText = (parseFloat(iom.remaining_fte||0)).toFixed(4);
    iomRemHrs.innerText = (parseFloat(iom.remaining_hours||0)).toFixed(2);
    iomDetailCard.style.display = 'flex';
  }

  async function fetchIomDetails(iom_row_id) {
    try {
      const project_id = projectSelect.value;
      const year = yearInput.value;
      const month = monthSelect.value;
      const resp = await fetch('{% url "projects:get_iom_details" %}?iom_row_id=' + encodeURIComponent(iom_row_id) + '&project_id=' + encodeURIComponent(project_id) + '&year=' + year + '&month=' + month, { credentials:'same-origin' });
      if (!resp.ok) return;
      const data = await resp.json();
      if (!data.ok) return;
      const iom = data.iom;
      showIomPreview(iom);
    } catch (err) {
      console.warn('iom details', err);
    }
  }

  function addIomRow(iom) {
    // avoid duplicate iom row
    if ([...allocBody.children].some(tr => tr.dataset.iomId == iom.iom_id)) { alert('IOM already added'); return; }

    const html = `
      <tr data-iom-id="${iom.iom_id}">
        <td><input class="form-control dept" value="${(iom.department||'').replace(/"/g,'&quot;')}" /></td>
        <td><input class="form-control iom_id" value="${iom.iom_id}" readonly /></td>
        <td><input class="form-control wbs_buyer" value="${(iom.buyer_wbs_cc||'').replace(/"/g,'&quot;')}" /></td>
        <td><input class="form-control wbs_seller" value="${(iom.seller_wbs_cc||'').replace(/"/g,'&quot;')}" /></td>
        <td><input class="form-control total_hrs" type="number" value="${parseFloat(iom.month_hours||0).toFixed(2)}" min="0" /></td>

        <!-- resource and its suggestion box (resource-td) -->
        <td class="resource-td">
          <input class="form-control user_ldap" placeholder="start typing (3+ chars)" aria-label="user ldap"/>
          <div class="ldap-suggest" style="display:none;"></div>
        </td>

        <!-- remove placed in its own column, will be visually below resource due to CSS -->
        <td class="remove-td">
          <button class="btn btn-sm btn-danger removeBtn btn-compact" aria-label="Remove resource">Remove</button>
        </td>
      </tr>
    `;
    const tr = document.createElement('tr');
    tr.innerHTML = html;
    const empty = allocBody.querySelector('.empty-state');
    if (empty) empty.remove();
    allocBody.appendChild(tr);
    tr.dataset.iomId = iom.iom_id;

    // attach remove
    const removeBtn = tr.querySelector('.removeBtn');
    removeBtn.addEventListener('click', () => tr.remove());

    // LDAP autocomplete - attach to the new input
    const ldapInput = tr.querySelector('.user_ldap');
    const suggestBox = tr.querySelector('.ldap-suggest');
    let timer = null;

    ldapInput.addEventListener('input', () => {
      const q = ldapInput.value.trim();
      suggestBox.innerHTML = '';
      suggestBox.style.display = 'none';
      if (timer) clearTimeout(timer);
      if (q.length < 3) return; // client-enforced minimum

      timer = setTimeout(async () => {
        try {
          const url = ldapEndpoint + '?q=' + encodeURIComponent(q);
          console.log('LDAP query:', url);
          const resp = await fetch(url, { credentials: 'same-origin' });
          if (!resp.ok) {
            console.warn('LDAP request failed', resp.status);
            return;
          }
          const data = await resp.json();
          if (!data || !Array.isArray(data.results)) {
            console.warn('LDAP unexpected response', data);
            return;
          }
          // show results
          data.results.forEach(r => {
            const a = document.createElement('a');
            a.href = '#';
            a.className = 'list-group-item list-group-item-action';
            // display-friendly: prefer "cn (mail)" or username
            a.textContent = (r.cn || r.sAMAccountName) + (r.mail ? ' <' + r.mail + '>' : '');
            a.dataset.mail = r.mail || r.sAMAccountName || '';
            a.onclick = (e) => { e.preventDefault(); ldapInput.value = a.dataset.mail; suggestBox.style.display='none'; };
            suggestBox.appendChild(a);
          });
          if (suggestBox.children.length) suggestBox.style.display = 'block';
        } catch (err) {
          console.error('LDAP fetch error', err);
        }
      }, 220);
    });

    // hide suggestion box when click outside
    document.addEventListener('click', (ev) => { if (!tr.contains(ev.target)) suggestBox.style.display='none'; });
  }

  addResourceBtn.addEventListener('click', () => {
    addIomRow({ iom_id:'', department:'', buyer_wbs_cc:'', seller_wbs_cc:'', month_hours:0 });
  });

  saveBtn.addEventListener('click', async () => {
    const project_id = projectSelect.value;
    if (!project_id) { alert('Select project'); return; }
    const year = yearInput.value;
    const month = monthSelect.value;
    const month_start = `${year}-${String(month).padStart(2,'0')}-01`;

    const rows = Array.from(allocBody.querySelectorAll('tr'));
    if (!rows.length) { alert('Nothing to save'); return; }

    const items = [];
    for (const r of rows) {
      if (r.classList.contains('empty-state')) continue;
      const user_ldap = (r.querySelector('.user_ldap') || {}).value || '';
      const total_hours = Math.round(parseFloat((r.querySelector('.total_hrs') || {}).value || 0));
      items.push({ coe_id: 0, domain_id: 0, user_ldap: user_ldap, total_hours: total_hours });
    }

    try {
      const resp = await fetch('{% url "projects:save_monthly_allocations" %}', {
        method:'POST',
        credentials:'same-origin',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ project_id, month_start, items })
      });
      const data = await resp.json();
      if (!data.ok) { alert('Save failed: ' + (data.error || 'unknown')); return; }
      alert('Saved successfully');
      location.reload();
    } catch (err) {
      console.error(err);
      alert('Save failed (open console)');
    }
  });

})();
</script>
{% endblock %}
