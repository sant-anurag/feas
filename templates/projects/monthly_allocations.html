{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'projects/css/projects.css' %}">
<style>
/* Small polished styling so the page looks professional immediately.
   Move these rules to your site CSS (people.css / ui.css) if you prefer. */
.alloc-card {
  max-width: 1200px;
  margin: 24px auto;
  padding: 22px;
  border-radius: 10px;
  background: #fff;
  box-shadow: 0 6px 20px rgba(22,45,80,0.06);
}
.alloc-toprow { gap:14px; align-items:end; }
.alloc-controls label { font-weight:600; font-size:0.92rem; color:#223; display:block; margin-bottom:6px; }
#iomsDropdown { min-width:360px; }
.table thead th { vertical-align: middle; text-align:left; }
.table td input.form-control { height:34px; padding:6px 8px; }
.ldap-suggest { position: absolute; z-index:1200; background:#fff; border:1px solid #ddd; width:100%; max-height:180px; overflow:auto; }
.small-muted { color:#6c757d; font-size:0.85rem; }
.btn-compact { padding:6px 10px; font-size:0.92rem; }
.empty-state { color:#6c757d; padding:18px 12px; background:#f8f9fb; border-radius:6px; }
@media (max-width:900px){
  .alloc-toprow { flex-direction:column; align-items:stretch; }
  #iomsDropdown { min-width:100%; }
}
</style>

<div class="alloc-card">
  <div class="d-flex justify-content-between">
    <h3 class="mb-0">Monthly Allocations</h3>
    <div class="small-muted">Manage resources and FTE per IOM</div>
  </div>

  <!-- Top controls -->
  <div class="d-flex alloc-toprow mt-3 alloc-controls">
    <div style="min-width:260px;">
      <label for="projectSelect">Project</label>
      <select id="projectSelect" class="form-select">
        {% for p in projects %}
          <option value="{{ p.id }}" {% if p.id == project_id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
        {% if not projects %}
          <option value="">-- No projects assigned --</option>
        {% endif %}
      </select>
    </div>

    <div style="width:130px;">
      <label for="yearInput">Year</label>
      <input id="yearInput" type="number" class="form-control" value="{{ now.year }}">
    </div>

    <div style="width:180px;">
      <label for="monthSelect">Month</label>
      <select id="monthSelect" class="form-select">
        <option value="1" {% if now.month == 1 %}selected{% endif %}>January</option>
        <option value="2" {% if now.month == 2 %}selected{% endif %}>February</option>
        <option value="3" {% if now.month == 3 %}selected{% endif %}>March</option>
        <option value="4" {% if now.month == 4 %}selected{% endif %}>April</option>
        <option value="5" {% if now.month == 5 %}selected{% endif %}>May</option>
        <option value="6" {% if now.month == 6 %}selected{% endif %}>June</option>
        <option value="7" {% if now.month == 7 %}selected{% endif %}>July</option>
        <option value="8" {% if now.month == 8 %}selected{% endif %}>August</option>
        <option value="9" {% if now.month == 9 %}selected{% endif %}>September</option>
        <option value="10" {% if now.month == 10 %}selected{% endif %}>October</option>
        <option value="11" {% if now.month == 11 %}selected{% endif %}>November</option>
        <option value="12" {% if now.month == 12 %}selected{% endif %}>December</option>
      </select>
    </div>

    <div style="display:flex; gap:8px; align-items:flex-end;">
      <button id="loadIomsBtn" class="btn btn-primary btn-compact">Load IOMs</button>
    </div>
  </div>

  <!-- IOM select + search -->
  <div class="row mt-3 g-2">
    <div class="col-md-7">
      <label class="form-label">Applicable IOMs</label>
      <div class="d-flex">
        <select id="iomsDropdown" class="form-select me-2">
          <option value="">-- Load IOMs then select --</option>
        </select>
        <button id="addIomBtn" class="btn btn-outline-secondary btn-compact">Add Selected IOM</button>
      </div>
    </div>
    <div class="col-md-5">
      <label class="form-label">Search IOM / Dept</label>
      <input id="searchIom" class="form-control" placeholder="iom id or department">
    </div>
  </div>

  <!-- IOM detail card -->
  <div id="iomDetailCard" class="card p-3 mt-3" style="display:none; border:1px solid #eef2f7;">
    <div class="d-flex justify-content-between">
      <div>
        <div><strong id="iomTitle">IOM:</strong></div>
        <div class="small-muted" id="iomDept"></div>
      </div>
      <div style="text-align:right;">
        <div class="small-muted">Month FTE: <strong id="iomMonthFte">0.00</strong></div>
        <div class="small-muted">Month Hrs: <strong id="iomMonthHrs">0.00</strong></div>
        <div class="small-muted">Remaining FTE: <strong id="iomRemFte">0.00</strong></div>
        <div class="small-muted">Remaining Hrs: <strong id="iomRemHrs">0.00</strong></div>
      </div>
    </div>
  </div>

  <!-- Allocation table -->
  <div class="table-responsive mt-3">
    <table class="table table-striped table-hover align-middle" id="allocTable">
      <thead class="table-light">
        <tr>
          <th style="min-width:160px;">Department</th>
          <th style="min-width:120px;">IOM</th>
          <th>WBS (Buyer)</th>
          <th>WBS (Seller)</th>
          <th style="width:120px;">Total Hrs</th>
          <th style="min-width:240px;">Resource (LDAP) <div class="small-muted">type 3+ chars to search</div></th>
          <th style="width:80px;">Remove</th>
        </tr>
      </thead>
      <tbody id="allocBody">
        <tr class="empty-state"><td colspan="7">No resources added yet. Load an IOM and click <strong>Add Selected IOM</strong> or use <strong>Add Resource</strong>.</td></tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex gap-2 mt-2">
    <button id="addResourceBtn" class="btn btn-outline-primary btn-compact">Add Resource</button>
    <button id="saveBtn" class="btn btn-success btn-compact">Save</button>
  </div>

  <div style="display:none">{% csrf_token %}<input id="csrfTokenValue" /></div>
</div>

<script>
/* Simplified JS: improved UX, no weekly percent columns, cleaner interactions.
   The template relies on endpoints already provided:
   - get_applicable_ioms (GET)
   - get_iom_details (GET)
   - allocations_ldap_search (GET?q=)
   - save_monthly_allocations (POST)
*/
(function(){
  const csrftoken = (function(){
    const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : (document.cookie.split('; ').find(c=>c.startsWith('csrftoken='))||'').split('=')[1] || '';
  })();

  const projectSelect = document.getElementById('projectSelect');
  const yearInput = document.getElementById('yearInput');
  const monthSelect = document.getElementById('monthSelect');
  const loadIomsBtn = document.getElementById('loadIomsBtn');
  const iomsDropdown = document.getElementById('iomsDropdown');
  const addIomBtn = document.getElementById('addIomBtn');
  const searchIom = document.getElementById('searchIom');
  const iomDetailCard = document.getElementById('iomDetailCard');
  const iomTitle = document.getElementById('iomTitle');
  const iomDept = document.getElementById('iomDept');
  const iomMonthFte = document.getElementById('iomMonthFte');
  const iomMonthHrs = document.getElementById('iomMonthHrs');
  const iomRemFte = document.getElementById('iomRemFte');
  const iomRemHrs = document.getElementById('iomRemHrs');
  const allocBody = document.getElementById('allocBody');
  const addResourceBtn = document.getElementById('addResourceBtn');
  const saveBtn = document.getElementById('saveBtn');

  function clearTableEmptyState() {
    const row = allocBody.querySelector('.empty-state');
    if (row) row.remove();
  }

  loadIomsBtn.addEventListener('click', async () => {
    const project_id = projectSelect.value;
    const year = yearInput.value;
    const month = monthSelect.value;
    const search = searchIom.value.trim();

    if (!project_id) { alert('Select a project'); return; }

    const params = new URLSearchParams({ project_id, year, month });
    if (search) params.set('search', search);

    try {
      const resp = await fetch('{% url "projects:get_applicable_ioms" %}?' + params.toString(), { credentials:'same-origin' });
      if (!resp.ok) throw new Error('Failed to load');
      const data = await resp.json();
      if (!data.ok) throw new Error(data.error || 'No data');
      iomsDropdown.innerHTML = '<option value="">-- Choose IOM --</option>';
      data.ioms.forEach(i => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify(i);
        opt.text = `${i.iom_id} · Dept:${i.department || '-'} · Hrs:${(i.month_hours||0).toFixed(2)}`;
        iomsDropdown.appendChild(opt);
      });
    } catch (err) {
      console.error(err);
      alert('Could not load IOMs');
    }
  });

  iomsDropdown.addEventListener('change', () => {
    if (!iomsDropdown.value) { iomDetailCard.style.display='none'; return; }
    const obj = JSON.parse(iomsDropdown.value);
    showIomPreview(obj);
  });

  addIomBtn.addEventListener('click', () => {
    if (!iomsDropdown.value) { alert('Select an IOM'); return; }
    const obj = JSON.parse(iomsDropdown.value);
    clearTableEmptyState();
    addIomRow(obj);
    fetchIomDetails(obj.id);
  });

  function showIomPreview(iom) {
    iomTitle.innerText = 'IOM: ' + iom.iom_id;
    iomDept.innerText = iom.department || '';
    iomMonthFte.innerText = (parseFloat(iom.month_fte||0)).toFixed(4);
    iomMonthHrs.innerText = (parseFloat(iom.month_hours||0)).toFixed(2);
    iomRemFte.innerText = '-';
    iomRemHrs.innerText = '-';
    iomDetailCard.style.display = 'block';
  }

  async function fetchIomDetails(iom_row_id) {
    try {
      const project_id = projectSelect.value;
      const year = yearInput.value;
      const month = monthSelect.value;
      const resp = await fetch('{% url "projects:get_iom_details" %}?iom_row_id=' + encodeURIComponent(iom_row_id) + '&project_id=' + encodeURIComponent(project_id) + '&year=' + year + '&month=' + month, { credentials:'same-origin' });
      if (!resp.ok) return;
      const data = await resp.json();
      if (!data.ok) return;
      const iom = data.iom;
      iomTitle.innerText = 'IOM: ' + iom.iom_id;
      iomDept.innerText = iom.department || '-';
      iomMonthFte.innerText = parseFloat(iom.month_fte||0).toFixed(4);
      iomMonthHrs.innerText = parseFloat(iom.month_hours||0).toFixed(2);
      iomRemFte.innerText = parseFloat(iom.remaining_fte||0).toFixed(4);
      iomRemHrs.innerText = parseFloat(iom.remaining_hours||0).toFixed(2);
    } catch (err) {
      console.warn('iom details', err);
    }
  }

  function addIomRow(iom) {
    // avoid duplicate iom row
    if ([...allocBody.children].some(tr => tr.dataset.iomId == iom.iom_id)) { alert('IOM already added'); return; }
    const html = `
      <tr data-iom-id="${iom.iom_id}">
        <td><input class="form-control dept" value="${(iom.department||'').replace(/"/g,'&quot;')}"></td>
        <td><input class="form-control iom_id" value="${iom.iom_id}" readonly></td>
        <td><input class="form-control wbs_buyer" value="${(iom.buyer_wbs_cc||'').replace(/"/g,'&quot;')}"></td>
        <td><input class="form-control wbs_seller" value="${(iom.seller_wbs_cc||'').replace(/"/g,'&quot;')}"></td>
        <td><input class="form-control total_hrs" type="number" value="${parseFloat(iom.month_hours||0).toFixed(2)}" min="0"></td>
        <td style="position:relative;">
          <input class="form-control user_ldap" placeholder="start typing (3+ chars)"/>
          <div class="ldap-suggest" style="display:none;"></div>
        </td>
        <td><button class="btn btn-sm btn-danger removeBtn btn-compact">Remove</button></td>
      </tr>
    `;
    const tr = document.createElement('tr');
    tr.innerHTML = html;
    // replace placeholder row if present
    const empty = allocBody.querySelector('.empty-state');
    if (empty) empty.remove();
    allocBody.appendChild(tr);
    tr.dataset.iomId = iom.iom_id;

    // attach remove
    tr.querySelector('.removeBtn').addEventListener('click', () => tr.remove());

    // LDAP autocomplete
    const ldapInput = tr.querySelector('.user_ldap');
    const suggestBox = tr.querySelector('.ldap-suggest');
    let timer = null;
    ldapInput.addEventListener('input', () => {
      const q = ldapInput.value.trim();
      suggestBox.innerHTML = '';
      suggestBox.style.display = 'none';
      if (timer) clearTimeout(timer);
      if (q.length < 3) return;
      timer = setTimeout(async () => {
        try {
          const resp = await fetch('{% url "projects:allocations_ldap_search" %}?q=' + encodeURIComponent(q), { credentials:'same-origin' });
          if (!resp.ok) return;
          const data = await resp.json();
          if (!data.ok) return;
          data.results.forEach(r => {
            const a = document.createElement('a');
            a.href = '#';
            a.className = 'list-group-item list-group-item-action';
            a.textContent = (r.mail || r.username || r.cn);
            a.dataset.mail = r.mail || r.username;
            a.onclick = (e) => { e.preventDefault(); ldapInput.value = a.dataset.mail; suggestBox.style.display='none'; };
            suggestBox.appendChild(a);
          });
          if (suggestBox.children.length) suggestBox.style.display = 'block';
        } catch (err) { console.warn(err); }
      }, 250);
    });

    // click outside hides suggest
    document.addEventListener('click', (ev) => { if (!tr.contains(ev.target)) suggestBox.style.display='none'; });
  }

  addResourceBtn.addEventListener('click', () => {
    // add an empty row
    addIomRow({ iom_id:'', department:'', buyer_wbs_cc:'', seller_wbs_cc:'', month_hours:0 });
  });

  saveBtn.addEventListener('click', async () => {
    const project_id = projectSelect.value;
    if (!project_id) { alert('Select project'); return; }
    const year = yearInput.value;
    const month = monthSelect.value;
    const month_start = `${year}-${String(month).padStart(2,'0')}-01`;

    const rows = Array.from(allocBody.querySelectorAll('tr'));
    if (!rows.length) { alert('Nothing to save'); return; }

    const items = [];
    for (const r of rows) {
      // skip empty-state rows
      if (r.classList.contains('empty-state')) continue;
      const user_ldap = (r.querySelector('.user_ldap') || {}).value || '';
      const iom_id = (r.querySelector('.iom_id') || {}).value || '';
      const dept = (r.querySelector('.dept') || {}).value || '';
      const wbs_b = (r.querySelector('.wbs_buyer') || {}).value || '';
      const wbs_s = (r.querySelector('.wbs_seller') || {}).value || '';
      const total_hours = Math.round(parseFloat((r.querySelector('.total_hrs') || {}).value || 0));
      // coe_id/domain_id left as 0/default; adjust if you collect these
      items.push({ coe_id: 0, domain_id: 0, user_ldap: user_ldap, total_hours: total_hours });
    }

    try {
      const resp = await fetch('{% url "projects:save_monthly_allocations" %}', {
        method:'POST',
        credentials:'same-origin',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ project_id, month_start, items })
      });
      const data = await resp.json();
      if (!data.ok) { alert('Save failed: ' + (data.error || 'unknown')); return; }
      alert('Saved successfully');
      location.reload();
    } catch (err) {
      console.error(err);
      alert('Save failed (open console)');
    }
  });

})();
</script>
{% endblock %}
